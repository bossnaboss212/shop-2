<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#00d4ff">
  <meta name="description" content="DROGUA CENTER - Votre boutique premium">
  <title>DROGUA CENTER</title>
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRFJPR1VBIENFTlRFUiIsInNob3J0X25hbWUiOiJEUk9HVUEiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGEwZTE0IiwidGhlbWVfY29sb3IiOiIjMDBkNGZmIn0=">
  <style>
:root{
  --bg-primary:#0a0e14;
  --bg-secondary:#141920;
  --bg-tertiary:#1a2028;
  --text-primary:#ffffff;
  --text-secondary:#b4bac5;
  --text-muted:#6b7280;
  --accent:#00d4ff;
  --accent-dark:#00a8cc;
  --success:#10b981;
  --danger:#ef4444;
  --warning:#f59e0b;
  --border:#ffffff10;
  --shadow-sm:0 2px 8px rgba(0,0,0,0.1);
  --shadow-md:0 4px 16px rgba(0,0,0,0.2);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.3);
  --shadow-glow:0 0 20px rgba(0,212,255,0.3);
}

[data-theme="light"]{
  --bg-primary:#f8fafc;
  --bg-secondary:#ffffff;
  --bg-tertiary:#f1f5f9;
  --text-primary:#0f172a;
  --text-secondary:#475569;
  --text-muted:#94a3b8;
  --border:#e2e8f0;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',sans-serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
  transition:background 0.3s, color 0.3s;
}

body.modal-open{overflow:hidden;position:fixed;width:100%}

.header{
  position:sticky;
  top:0;
  z-index:100;
  background:rgba(10,14,20,0.95);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  padding:16px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

[data-theme="light"] .header{background:rgba(255,255,255,0.95)}

.menu-btn{
  background:transparent;
  border:none;
  padding:8px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:transform 0.2s;
}

.menu-btn:active{transform:scale(0.95)}

.hamburger{display:flex;flex-direction:column;gap:4px;width:22px}

.hamburger span{
  width:100%;
  height:2px;
  background:var(--text-primary);
  border-radius:2px;
  transition:all 0.3s;
}

.logo-container{position:absolute;left:50%;transform:translateX(-50%)}

.logo{
  width:52px;
  height:52px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  box-shadow:var(--shadow-glow);
  animation:float 3s ease-in-out infinite;
}

.logo img{width:100%;height:100%;object-fit:cover}

@keyframes float{
  0%,100%{transform:translateY(0px)}
  50%{transform:translateY(-4px)}
}

.header-actions{display:flex;gap:8px;align-items:center}

.theme-toggle{
  background:var(--bg-tertiary);
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.2s;
}

.theme-toggle:hover{
  background:var(--bg-secondary);
  border-color:var(--accent);
}

.theme-icon{
  width:20px;
  height:20px;
  stroke:var(--text-primary);
  fill:none;
  stroke-width:2;
}

.cart-btn{
  background:var(--bg-tertiary);
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px 14px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  transition:all 0.2s;
  position:relative;
}

.cart-btn:hover{
  background:var(--bg-secondary);
  border-color:var(--accent);
  transform:translateY(-2px);
  box-shadow:var(--shadow-md);
}

.cart-icon{width:20px;height:20px;stroke:var(--text-primary);fill:none;stroke-width:2}

.badge{
  background:var(--accent);
  color:var(--bg-primary);
  border-radius:20px;
  padding:2px 8px;
  font-size:12px;
  font-weight:700;
  min-width:20px;
  text-align:center;
}

.loyalty-banner{
  background:linear-gradient(135deg,var(--accent) 0%,#764ba2 100%);
  padding:12px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  cursor:pointer;
  transition:all 0.2s;
}

.loyalty-banner:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}

.loyalty-info{display:flex;align-items:center;gap:12px;flex:1}

.loyalty-icon{
  width:40px;
  height:40px;
  background:rgba(255,255,255,0.2);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
}

.loyalty-text{flex:1}

.loyalty-title{font-weight:700;font-size:14px;color:#fff;margin-bottom:2px}

.loyalty-subtitle{font-size:12px;color:rgba(255,255,255,0.9)}

.loyalty-progress{
  width:100%;
  height:6px;
  background:rgba(255,255,255,0.2);
  border-radius:3px;
  overflow:hidden;
  margin-top:8px;
}

.loyalty-bar{
  height:100%;
  background:#fff;
  border-radius:3px;
  transition:width 0.5s ease;
}

.menu-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  backdrop-filter:blur(4px);
  z-index:998;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.3s;
}

.menu-overlay.open{opacity:1;pointer-events:all}

.side-menu{
  position:fixed;
  top:0;
  left:0;
  width:300px;
  height:100%;
  background:var(--bg-secondary);
  border-right:1px solid var(--border);
  transform:translateX(-100%);
  transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
  z-index:999;
  display:flex;
  flex-direction:column;
}

.side-menu.open{transform:translateX(0)}

.menu-header{
  padding:24px 20px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.menu-header h3{font-size:22px;font-weight:700}

.menu-close{
  background:transparent;
  border:none;
  color:var(--text-primary);
  font-size:28px;
  cursor:pointer;
  padding:0;
  line-height:1;
  transition:transform 0.2s;
}

.menu-close:active{transform:rotate(90deg)}

.menu-items{flex:1;padding:12px 0;overflow-y:auto}

.menu-item{
  display:flex;
  align-items:center;
  gap:16px;
  padding:16px 20px;
  color:var(--text-primary);
  font-size:16px;
  font-weight:500;
  cursor:pointer;
  transition:all 0.2s;
  border:none;
  background:transparent;
  width:100%;
  text-align:left;
  border-left:3px solid transparent;
}

.menu-item:hover{
  background:var(--bg-tertiary);
  border-left-color:var(--accent);
}

.menu-item svg{width:22px;height:22px;stroke:var(--accent);fill:none;stroke-width:2}

.hero{
  padding:40px 20px 30px;
  text-align:center;
  background:linear-gradient(180deg,var(--bg-secondary) 0%,var(--bg-primary) 100%);
  position:relative;
  overflow:hidden;
}

.hero::before{
  content:'';
  position:absolute;
  top:-50%;
  left:-50%;
  width:200%;
  height:200%;
  background:radial-gradient(circle,rgba(0,212,255,0.1) 0%,transparent 70%);
  animation:rotate 20s linear infinite;
}

@keyframes rotate{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}

.hero-content{position:relative;z-index:1}

.hero h1{
  font-size:42px;
  font-weight:800;
  letter-spacing:-1px;
  margin-bottom:12px;
  background:linear-gradient(135deg,var(--accent) 0%,#764ba2 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

.hero-subtitle{color:var(--text-secondary);font-size:18px;font-weight:500}

.search-section{
  padding:20px;
  position:sticky;
  top:84px;
  z-index:90;
  background:rgba(10,14,20,0.95);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
}

[data-theme="light"] .search-section{background:rgba(255,255,255,0.95)}

.search-box{position:relative}

.search-input{
  width:100%;
  padding:14px 50px 14px 46px;
  background:var(--bg-tertiary);
  border:2px solid var(--border);
  border-radius:16px;
  color:var(--text-primary);
  font-size:15px;
  transition:all 0.2s;
}

.search-input:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(0,212,255,0.1);
}

.search-icon{
  position:absolute;
  left:16px;
  top:50%;
  transform:translateY(-50%);
  width:20px;
  height:20px;
  stroke:var(--text-muted);
  fill:none;
  stroke-width:2;
}

.filter-btn{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  background:var(--accent);
  border:none;
  border-radius:10px;
  padding:8px 16px;
  color:var(--bg-primary);
  font-weight:600;
  font-size:13px;
  cursor:pointer;
  transition:all 0.2s;
}

.sort-bar{
  padding:12px 20px;
  display:flex;
  gap:10px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  border-bottom:1px solid var(--border);
}

.sort-bar::-webkit-scrollbar{display:none}

.sort-chip{
  padding:8px 16px;
  background:var(--bg-tertiary);
  border:2px solid var(--border);
  border-radius:16px;
  color:var(--text-secondary);
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
  white-space:nowrap;
}

.sort-chip:hover{background:var(--bg-secondary);border-color:var(--accent)}

.sort-chip.active{
  background:var(--accent);
  border-color:var(--accent);
  color:var(--bg-primary);
}

.categories{
  padding:16px 20px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
}

.categories::-webkit-scrollbar{display:none}

.categories-scroll{display:flex;gap:10px;min-width:max-content}

.category-chip{
  padding:10px 18px;
  background:var(--bg-tertiary);
  border:2px solid var(--border);
  border-radius:20px;
  color:var(--text-secondary);
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
  white-space:nowrap;
}

.category-chip:hover{background:var(--bg-secondary);border-color:var(--accent)}

.category-chip.active{
  background:var(--accent);
  border-color:var(--accent);
  color:var(--bg-primary);
  box-shadow:var(--shadow-glow);
}

.page{display:none;padding-bottom:80px}
.page.active{display:block}

.products-header{
  padding:24px 20px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.products-title{font-size:24px;font-weight:700}

.results-count{color:var(--text-muted);font-size:14px}

.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:16px;
  padding:0 20px 20px;
}

@keyframes slideUp{
  from{transform:translateY(20px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

.product-card{
  background:var(--bg-secondary);
  border:1px solid var(--border);
  border-radius:20px;
  overflow:hidden;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
  position:relative;
  animation:slideUp 0.3s ease-out;
  animation-fill-mode:both;
}

.product-card:nth-child(1){animation-delay:0.05s}
.product-card:nth-child(2){animation-delay:0.1s}
.product-card:nth-child(3){animation-delay:0.15s}
.product-card:nth-child(4){animation-delay:0.2s}

.product-card:hover{
  transform:translateY(-4px) scale(1.02);
  box-shadow:var(--shadow-lg);
  border-color:var(--accent);
}

.product-thumb{
  width:100%;
  aspect-ratio:1/1;
  position:relative;
  overflow:hidden;
  background:var(--bg-tertiary);
}

.product-thumb::after{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(180deg,transparent 0%,rgba(0,0,0,0.4) 100%);
  z-index:1;
}

.product-video{width:100%;height:100%;object-fit:cover}

.product-actions{
  position:absolute;
  top:12px;
  right:12px;
  display:flex;
  gap:8px;
  z-index:2;
}

.product-action-btn{
  width:36px;
  height:36px;
  background:rgba(0,0,0,0.7);
  backdrop-filter:blur(10px);
  border:none;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:all 0.2s;
}

.product-action-btn:hover{background:var(--accent);transform:scale(1.1)}

.product-action-btn svg{width:18px;height:18px;stroke:var(--text-primary);fill:none;stroke-width:2}

.product-action-btn.active svg{fill:var(--danger);stroke:var(--danger)}

.product-rating{
  position:absolute;
  top:12px;
  left:12px;
  background:rgba(0,0,0,0.7);
  backdrop-filter:blur(10px);
  padding:6px 10px;
  border-radius:20px;
  display:flex;
  align-items:center;
  gap:4px;
  z-index:2;
}

.product-rating span:first-child{font-size:14px}

.product-rating span:last-child{
  color:var(--text-primary);
  font-weight:700;
  font-size:13px;
}

.product-meta{padding:14px}

.product-farm{
  color:var(--text-muted);
  font-size:12px;
  font-weight:500;
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:6px;
}

.product-name{font-size:16px;font-weight:700;margin-bottom:10px;line-height:1.3}

.product-price{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.price-from{color:var(--text-muted);font-size:12px}

.price-amount{color:var(--accent);font-size:18px;font-weight:700}

.spinner{
  width:40px;
  height:40px;
  border:4px solid var(--border);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin 0.8s linear infinite;
  margin:20px auto;
}

@keyframes spin{to{transform:rotate(360deg)}}

.promo-section{margin:20px 0}

.promo-input-wrapper{display:flex;gap:10px}

.promo-input{
  flex:1;
  padding:14px 16px;
  background:var(--bg-tertiary);
  border:2px solid var(--border);
  border-radius:12px;
  color:var(--text-primary);
  font-size:15px;
  text-transform:uppercase;
  transition:all 0.2s;
}

.promo-input:focus{outline:none;border-color:var(--accent)}

.promo-input.valid{border-color:var(--success)}

.promo-input.invalid{border-color:var(--danger);animation:shake 0.3s}

@keyframes shake{
  0%,100%{transform:translateX(0)}
  25%{transform:translateX(-10px)}
  75%{transform:translateX(10px)}
}

.promo-btn{
  padding:14px 24px;
  background:var(--accent);
  border:none;
  border-radius:12px;
  color:var(--bg-primary);
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
}

.promo-btn:hover{background:var(--accent-dark)}

.promo-applied{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(16,185,129,0.1);
  border:2px solid var(--success);
  border-radius:12px;
  padding:12px 16px;
  margin-top:12px;
}

.promo-applied-text{
  display:flex;
  align-items:center;
  gap:8px;
  color:var(--success);
  font-weight:600;
  font-size:14px;
}

.promo-remove{
  background:transparent;
  border:none;
  color:var(--danger);
  cursor:pointer;
  font-size:18px;
  padding:4px;
  line-height:1;
}

.confirm-dialog{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  backdrop-filter:blur(4px);
  z-index:2000;
  display:flex;
  align-items:center;
  justify-content:center;
  animation:fadeIn 0.2s;
}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.confirm-content{
  background:var(--bg-secondary);
  border:1px solid var(--border);
  border-radius:20px;
  padding:30px;
  max-width:400px;
  width:90%;
  animation:scaleIn 0.3s;
}

@keyframes scaleIn{
  from{transform:scale(0);opacity:0}
  to{transform:scale(1);opacity:1}
}

.confirm-content p{
  font-size:18px;
  font-weight:600;
  margin-bottom:24px;
  text-align:center;
}

.confirm-content button{
  padding:12px 24px;
  border:none;
  border-radius:12px;
  font-weight:600;
  font-size:15px;
  cursor:pointer;
  transition:all 0.2s;
  width:calc(50% - 6px);
}

.confirm-content #confirmYes{
  background:var(--danger);
  color:#fff;
  margin-right:12px;
}

.confirm-content #confirmYes:hover{background:#dc2626}

.confirm-content #confirmNo{
  background:var(--bg-tertiary);
  color:var(--text-primary);
  border:1px solid var(--border);
}

.confirm-content #confirmNo:hover{background:var(--bg-primary)}

.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:rgba(10,14,20,0.95);
  backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding:8px 0 calc(8px + env(safe-area-inset-bottom));
  display:flex;
  justify-content:space-around;
  z-index:99;
}

[data-theme="light"] .bottom-nav{background:rgba(255,255,255,0.95)}

.nav-item{
  background:transparent;
  border:none;
  color:var(--text-muted);
  cursor:pointer;
  padding:8px 16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  transition:all 0.2s;
  position:relative;
  flex:1;
}

.nav-item::before{
  content:'';
  position:absolute;
  top:0;
  left:50%;
  transform:translateX(-50%);
  width:0;
  height:3px;
  background:var(--accent);
  border-radius:0 0 3px 3px;
  transition:width 0.2s;
}

.nav-item.active::before{width:40px}

.nav-item.active{color:var(--accent)}

.nav-icon{width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:2}

.nav-label{font-size:11px;font-weight:600}

.nav-badge{
  position:absolute;
  top:4px;
  right:8px;
  background:var(--accent);
  color:var(--bg-primary);
  border-radius:10px;
  padding:2px 6px;
  font-size:10px;
  font-weight:700;
  min-width:18px;
  text-align:center;
}

.sheet{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  backdrop-filter:blur(4px);
  z-index:1000;
  display:flex;
  align-items:flex-end;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.3s;
}

.sheet:not(.hidden){opacity:1;pointer-events:all}

.sheet-card{
  background:var(--bg-secondary);
  border:1px solid var(--border);
  border-top-left-radius:24px;
  border-top-right-radius:24px;
  width:100%;
  max-height:90vh;
  display:flex;
  flex-direction:column;
  transform:translateY(100%);
  transition:transform 0.4s cubic-bezier(0.4,0,0.2,1);
}

.sheet:not(.hidden) .sheet-card{transform:translateY(0)}

.sheet-handle{
  width:40px;
  height:4px;
  background:var(--border);
  border-radius:2px;
  margin:12px auto 16px;
}

.sheet-header{
  padding:0 20px 20px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.sheet-title{font-size:24px;font-weight:700}

.sheet-close{
  background:var(--bg-tertiary);
  border:1px solid var(--border);
  border-radius:12px;
  color:var(--text-primary);
  font-size:24px;
  cursor:pointer;
  padding:8px 12px;
  line-height:1;
  transition:all 0.2s;
}

.sheet-close:hover{background:var(--bg-primary);transform:rotate(90deg)}

.sheet-content{
  flex:1;
  overflow-y:auto;
  padding:20px;
  -webkit-overflow-scrolling:touch;
}

.sheet-footer{
  padding:16px 20px;
  border-top:1px solid var(--border);
  background:var(--bg-tertiary);
}

.btn-primary{
  background:var(--accent);
  color:var(--bg-primary);
  border:none;
  border-radius:14px;
  padding:16px 24px;
  font-weight:700;
  font-size:16px;
  cursor:pointer;
  width:100%;
  transition:all 0.2s;
  box-shadow:0 4px 12px rgba(0,212,255,0.3);
  position:relative;
}

.btn-primary:hover{
  background:var(--accent-dark);
  transform:translateY(-2px);
  box-shadow:0 6px 16px rgba(0,212,255,0.4);
}

.btn-primary:active{transform:translateY(0)}

.btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}

.btn-primary.loading::after{
  content:'';
  position:absolute;
  right:20px;
  top:50%;
  transform:translateY(-50%);
  width:20px;
  height:20px;
  border:2px solid transparent;
  border-top-color:var(--bg-primary);
  border-radius:50%;
  animation:spin 0.6s linear infinite;
}

.info-section{padding:20px;max-width:600px;margin:0 auto}

.section-title{
  font-size:28px;
  font-weight:700;
  text-align:center;
  margin-bottom:30px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
}

.info-card{
  background:var(--bg-secondary);
  border:1px solid var(--border);
  border-radius:16px;
  padding:20px;
  margin-bottom:16px;
  display:flex;
  align-items:center;
  gap:16px;
  cursor:pointer;
  transition:all 0.2s;
  text-decoration:none;
  color:var(--text-primary);
}

.info-card:hover{
  background:var(--bg-tertiary);
  border-color:var(--accent);
  transform:translateX(4px);
}

.info-icon{
  width:48px;
  height:48px;
  background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
}

.info-icon svg{width:24px;height:24px;stroke:var(--bg-primary);fill:none;stroke-width:2}

.info-text{font-size:18px;font-weight:600}

.order-card{
  background:var(--bg-tertiary);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  margin-bottom:12px;
  cursor:pointer;
  transition:all 0.2s;
}

.order-card:hover{border-color:var(--accent);transform:translateY(-2px)}

.order-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

.order-number{font-weight:700;font-size:16px;color:var(--accent)}

.order-status{
  padding:4px 12px;
  border-radius:12px;
  font-size:12px;
  font-weight:600;
}

.order-status.delivered{background:rgba(16,185,129,0.2);color:var(--success)}

.order-status.pending{background:rgba(245,158,11,0.2);color:var(--warning)}

.order-date{color:var(--text-muted);font-size:13px;margin-bottom:8px}

.order-items{color:var(--text-secondary);font-size:14px;margin-bottom:8px}

.order-total{font-weight:700;font-size:18px;color:var(--accent)}

.toast{
  position:fixed;
  top:100px;
  left:50%;
  transform:translateX(-50%) translateY(-120px);
  background:var(--bg-secondary);
  border:1px solid var(--accent);
  box-shadow:var(--shadow-glow);
  padding:16px 24px;
  border-radius:16px;
  z-index:2000;
  display:flex;
  align-items:center;
  gap:12px;
  opacity:0;
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
  min-width:250px;
}

.toast.show{transform:translateX(-50%) translateY(0);opacity:1}

.toast-icon{
  width:24px;
  height:24px;
  background:var(--accent);
  color:var(--bg-primary);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  flex-shrink:0;
}

.toast-text{font-weight:600;font-size:15px}

.product-image{
  width:100%;
  height:300px;
  border-radius:16px;
  margin-bottom:20px;
  position:relative;
  overflow:hidden;
  background:var(--bg-tertiary);
}

.product-image-video{width:100%;height:100%;object-fit:cover}

.product-detail-header{margin-bottom:24px}

.product-detail-farm{
  color:var(--text-muted);
  font-size:13px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:8px;
}

.product-detail-name{font-size:28px;font-weight:800;margin-bottom:12px;line-height:1.2}

.product-detail-rating{display:flex;align-items:center;gap:8px;color:var(--text-secondary)}

.variants-section{margin:24px 0}

.variants-title{font-size:16px;font-weight:700;margin-bottom:16px;color:var(--text-secondary)}

.variant-option{
  background:var(--bg-tertiary);
  border:2px solid var(--border);
  border-radius:16px;
  padding:16px;
  margin-bottom:12px;
  cursor:pointer;
  transition:all 0.2s;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:relative;
}

.variant-option:hover{background:var(--bg-primary);border-color:var(--accent)}

.variant-option.selected{
  background:rgba(0,212,255,0.1);
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(0,212,255,0.1);
}

.variant-option.selected::after{
  content:'✓';
  position:absolute;
  top:12px;
  right:12px;
  width:24px;
  height:24px;
  background:var(--accent);
  color:var(--bg-primary);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:14px;
}

.variant-label{font-weight:600;font-size:16px;margin-bottom:4px}

.variant-grams{color:var(--text-muted);font-size:13px}

.variant-price{font-size:22px;font-weight:700;color:var(--accent)}

.qty-selector{
  display:flex;
  align-items:center;
  gap:20px;
  justify-content:center;
  margin:24px 0;
  padding:16px;
  background:var(--bg-tertiary);
  border-radius:16px;
}

.qty-label{color:var(--text-secondary);font-weight:600;font-size:14px}

.qty-controls{display:flex;align-items:center;gap:16px}

.qty-btn{
  width:40px;
  height:40px;
  background:var(--bg-secondary);
  border:2px solid var(--border);
  border-radius:12px;
  color:var(--text-primary);
  font-size:20px;
  font-weight:700;
  cursor:pointer;
  transition:all 0.2s;
  display:flex;
  align-items:center;
  justify-content:center;
}

.qty-btn:hover{background:var(--bg-primary);border-color:var(--accent);transform:scale(1.05)}

.qty-btn:active{transform:scale(0.95)}

.qty-display{font-size:24px;font-weight:700;min-width:40px;text-align:center}

.add-to-cart-bar{
  position:sticky;
  bottom:0;
  left:0;
  right:0;
  background:rgba(10,14,20,0.98);
  backdrop-filter:blur(20px);
  padding:16px;
  border-top:1px solid var(--border);
  display:flex;
  gap:12px;
  z-index:10;
}

[data-theme="light"] .add-to-cart-bar{background:rgba(255,255,255,0.98)}

.price-info{flex:1;display:flex;flex-direction:column;justify-content:center}

.price-label{color:var(--text-muted);font-size:12px;margin-bottom:2px}

.price-value{color:var(--accent);font-size:20px;font-weight:700}

.add-btn{
  flex:1;
  background:var(--accent);
  color:var(--bg-primary);
  border:none;
  border-radius:14px;
  padding:14px 24px;
  font-weight:700;
  font-size:16px;
  cursor:pointer;
  transition:all 0.2s;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

.add-btn:hover{background:var(--accent-dark);transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,212,255,0.4)}

.add-btn:active{transform:translateY(0)}

.cart-empty{text-align:center;color:var(--text-muted);padding:60px 20px}

.cart-empty svg{width:64px;height:64px;stroke:var(--text-muted);margin-bottom:16px}

.cart-item{
  background:var(--bg-tertiary);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  margin-bottom:12px;
  display:flex;
  gap:16px;
}

.cart-item-image{
  width:80px;
  height:80px;
  border-radius:12px;
  flex-shrink:0;
  overflow:hidden;
  background:var(--bg-secondary);
}

.cart-item-video{width:100%;height:100%;object-fit:cover}

.cart-item-info{flex:1;min-width:0}

.cart-item-name{font-weight:700;font-size:16px;margin-bottom:4px}

.cart-item-variant{color:var(--text-muted);font-size:13px;margin-bottom:8px}

.cart-item-price{color:var(--accent);font-size:18px;font-weight:700}

.cart-item-actions{
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:flex-end;
  justify-content:space-between;
}

.delete-btn{
  background:var(--danger);
  border:none;
  border-radius:8px;
  padding:6px 10px;
  color:var(--text-primary);
  cursor:pointer;
  transition:all 0.2s;
}

.delete-btn:hover{background:#dc2626;transform:scale(1.05)}

.cart-total{
  background:var(--bg-tertiary);
  border-radius:16px;
  padding:20px;
  margin:20px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.total-label{font-size:18px;font-weight:600;color:var(--text-secondary)}

.total-amount{font-size:28px;font-weight:800;color:var(--accent)}

.delivery-section{margin:24px 0}

.section-label{font-size:16px;font-weight:700;margin-bottom:16px;color:var(--text-secondary)}

.delivery-options{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}

.delivery-option{
  background:var(--bg-tertiary);
  border:2px solid var(--border);
  border-radius:16px;
  padding:16px;
  cursor:pointer;
  transition:all 0.2s;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:relative;
}

.delivery-option:hover{background:var(--bg-primary);border-color:var(--accent)}

.delivery-option.selected{
  background:rgba(0,212,255,0.1);
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(0,212,255,0.1);
}

.delivery-option.selected::after{
  content:'✓';
  position:absolute;
  top:12px;
  right:12px;
  width:24px;
  height:24px;
  background:var(--accent);
  color:var(--bg-primary);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:14px;
}

.delivery-info{flex:1}

.delivery-title{font-weight:600;font-size:16px;margin-bottom:4px}

.delivery-price{color:var(--text-muted);font-size:13px}

.address-section{margin-top:20px}

.input-wrapper{position:relative;margin-bottom:16px}

.input-field{
  width:100%;
  padding:14px 16px;
  background:var(--bg-tertiary);
  border:2px solid var(--border);
  border-radius:12px;
  color:var(--text-primary);
  font-size:15px;
  transition:all 0.2s;
}

.input-field:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(0,212,255,0.1);
}

.suggestions{
  position:absolute;
  top:100%;
  left:0;
  right:0;
  background:var(--bg-secondary);
  border:2px solid var(--accent);
  border-radius:12px;
  margin-top:8px;
  max-height:200px;
  overflow-y:auto;
  z-index:100;
  box-shadow:var(--shadow-lg);
}

.suggestion-item{
  padding:12px 16px;
  cursor:pointer;
  transition:background 0.2s;
  border-bottom:1px solid var(--border);
}

.suggestion-item:last-child{border-bottom:none}

.suggestion-item:hover{background:var(--bg-tertiary)}

.anonymous-info{
  background:rgba(0,212,255,0.1);
  border:2px solid var(--accent);
  border-radius:16px;
  padding:16px;
  margin-bottom:20px;
  display:flex;
  align-items:start;
  gap:12px;
}

.anonymous-icon{
  width:32px;
  height:32px;
  background:var(--accent);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  font-size:18px;
}

.anonymous-text{flex:1}

.anonymous-title{font-weight:700;font-size:16px;margin-bottom:4px;color:var(--accent)}

.anonymous-subtitle{color:var(--text-secondary);font-size:14px;line-height:1.5}

@media (min-width:768px){
  .grid{grid-template-columns:repeat(3,1fr);gap:20px}
  .sheet{align-items:center}
  .sheet-card{max-width:500px;border-radius:24px}
  #orderSummarySheet .sheet-card{max-width:600px}
}
  </style>
</head>
<body>
  <div class="menu-overlay" id="menuOverlay"></div>
  
  <div class="side-menu" id="sideMenu">
    <div class="menu-header">
      <h3>Menu</h3>
      <button class="menu-close" id="menuClose">✕</button>
    </div>
    <div class="menu-items">
      <button class="menu-item" data-page="home">
        <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        <span>Accueil</span>
      </button>
      <button class="menu-item" data-page="favorites">
        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
        <span>Favoris</span>
      </button>
      <button class="menu-item" data-page="orders">
        <svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
        <span>Mes Commandes</span>
      </button>
      <button class="menu-item" data-page="loyalty">
        <svg viewBox="0 0 24 24"><path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h6"></path><polyline points="9 11 12 14 22 4"></polyline></svg>
        <span>Fidélité</span>
      </button>
      <button class="menu-item" data-page="infos">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
        <span>Informations</span>
      </button>
      <button class="menu-item" data-page="avis">
        <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
        <span>Avis clients</span>
      </button>
      <button class="menu-item" data-page="support">
        <svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
        <span>Support</span>
      </button>
    </div>
  </div>

  <header class="header">
    <button class="menu-btn" id="menuBtn">
      <div class="hamburger"><span></span><span></span><span></span></div>
    </button>
    <div class="logo-container">
      <div class="logo">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2300d4ff'/%3E%3Ctext x='50' y='65' font-size='40' font-weight='bold' text-anchor='middle' fill='%230a0e14'%3EDC%3C/text%3E%3C/svg%3E" alt="DROGUA CENTER">
      </div>
    </div>
    <div class="header-actions">
      <button class="theme-toggle" id="themeToggle">
        <svg class="theme-icon" id="themeIcon" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
      <button class="cart-btn" id="cartBtn">
        <svg class="cart-icon" viewBox="0 0 24 24">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        <span class="badge" id="badge">0</span>
      </button>
    </div>
  </header>

  <div class="loyalty-banner" id="loyaltyBanner">
    <div class="loyalty-info">
      <div class="loyalty-icon">🎁</div>
      <div class="loyalty-text">
        <div class="loyalty-title" id="loyaltyTitle">Programme fidélité</div>
        <div class="loyalty-subtitle" id="loyaltySubtitle">0/10 commandes</div>
        <div class="loyalty-progress">
          <div class="loyalty-bar" id="loyaltyBar" style="width:0%"></div>
        </div>
      </div>
    </div>
  </div>

  <main class="page active" id="page-home">
    <section class="hero">
      <div class="hero-content">
        <h1>DROGUA CENTER</h1>
        <p class="hero-subtitle">Votre boutique premium</p>
      </div>
    </section>

    <section class="search-section">
      <div class="search-box">
        <svg class="search-icon" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" class="search-input" placeholder="Rechercher un produit..." id="searchInput">
        <button class="filter-btn" id="filterBtn">Filtrer</button>
      </div>
    </section>

    <section class="sort-bar" id="sortBar">
      <div class="sort-chip active" data-sort="default"><span>Par défaut</span></div>
      <div class="sort-chip" data-sort="price-asc"><span>Prix ↑</span></div>
      <div class="sort-chip" data-sort="price-desc"><span>Prix ↓</span></div>
      <div class="sort-chip" data-sort="name"><span>Nom A-Z</span></div>
    </section>

    <section class="categories">
      <div class="categories-scroll" id="categoriesScroll">
        <button class="category-chip active" data-cat="all">Tout</button>
        <button class="category-chip" data-cat="blanche">❄️ blanche</button>
        <button class="category-chip" data-cat="keta">☁️ keta</button>
        <button class="category-chip" data-cat="bonbon">💊 Bonbon</button>
        <button class="category-chip" data-cat="mdma">🌈 mdma</button>
        <button class="category-chip" data-cat="weed">🌿 Weed</button>
        <button class="category-chip" data-cat="filtré">🤯 filtré</button>
        <button class="category-chip" data-cat="mousseux">🧽 mousseux</button>
        <button class="category-chip" data-cat="cali">🇺🇸 Cali</button>
      </div>
    </section>

    <div class="products-header">
      <h2 class="products-title">Produits</h2>
      <span class="results-count" id="resultsCount">12 articles</span>
    </div>
    <div class="grid" id="productGrid"></div>
  </main>

  <main class="page" id="page-favorites">
    <div class="info-section">
      <h2 class="section-title">
        <svg style="width:32px;height:32px;stroke:var(--accent);fill:none;stroke-width:2" viewBox="0 0 24 24">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        Mes Favoris
      </h2>
      <div id="favoritesList"></div>
    </div>
  </main>

  <main class="page" id="page-orders">
    <div class="info-section">
      <h2 class="section-title">
        <svg style="width:32px;height:32px;stroke:var(--accent);fill:none;stroke-width:2" viewBox="0 0 24 24">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
          <line x1="1" y1="10" x2="23" y2="10"></line>
        </svg>
        Mes Commandes
      </h2>
      <div id="ordersList"></div>
    </div>
  </main>

  <main class="page" id="page-loyalty">
    <div class="info-section">
      <h2 class="section-title">🎁 Programme Fidélité</h2>
      <div id="loyaltyDetails"></div>
    </div>
  </main>

  <main class="page" id="page-infos">
    <div class="info-section">
      <h2 class="section-title">
        <svg style="width:32px;height:32px;stroke:var(--accent);fill:none;stroke-width:2" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        Informations
      </h2>
      <a href="https://t.me/+MToYP95G9zY2ZTJk" target="_blank" class="info-card">
        <div class="info-icon">
          <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </div>
        <span class="info-text">Canal Principal</span>
      </a>
      <a href="https://t.me/+usSUbJOfYsk5ZTg0" target="_blank" class="info-card">
        <div class="info-icon" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)">
          <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
        </div>
        <span class="info-text">Canal Photo</span>
      </a>
      <a href="https://snapchat.com/t/l9gurvAj" target="_blank" class="info-card">
        <div class="info-icon" style="background:linear-gradient(135deg,#facc15 0%,#fb923c 100%)">
          <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        </div>
        <span class="info-text">Snapchat</span>
      </a>
      <a href="https://snapchat.com/t/jR2yW7xa" target="_blank" class="info-card">
        <div class="info-icon" style="background:var(--danger)">
          <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        </div>
        <span class="info-text">Snapchat Secours 🆘</span>
      </a>
    </div>
  </main>

  <main class="page" id="page-avis">
    <div class="info-section">
      <h2 class="section-title">⭐ Avis clients</h2>
      <div style="background:var(--bg-secondary);border:2px solid var(--border);border-radius:16px;padding:20px;margin-bottom:24px">
        <h3 style="font-size:18px;font-weight:700;margin-bottom:16px">Laisser un avis</h3>
        <div style="margin-bottom:16px">
          <label for="reviewName" style="display:block;margin-bottom:8px;color:var(--text-secondary);font-size:14px;font-weight:600">Votre nom (optionnel)</label>
          <input type="text" class="input-field" id="reviewName" placeholder="Anonyme" style="margin:0">
        </div>
        <div style="margin-bottom:16px">
          <label for="reviewStars" style="display:block;margin-bottom:8px;color:var(--text-secondary);font-size:14px;font-weight:600">Note</label>
          <select class="input-field" id="reviewStars" style="margin:0">
            <option value="5">⭐⭐⭐⭐⭐ Excellent (5/5)</option>
            <option value="4">⭐⭐⭐⭐ Très bien (4/5)</option>
            <option value="3">⭐⭐⭐ Bien (3/5)</option>
            <option value="2">⭐⭐ Moyen (2/5)</option>
            <option value="1">⭐ Mauvais (1/5)</option>
          </select>
        </div>
        <div style="margin-bottom:16px">
          <label for="reviewText" style="display:block;margin-bottom:8px;color:var(--text-secondary);font-size:14px;font-weight:600">Votre avis</label>
          <textarea class="input-field" id="reviewText" placeholder="Partagez votre expérience..." rows="4" style="margin:0;resize:vertical"></textarea>
        </div>
        <button class="btn-primary" id="submitReview">📝 Publier mon avis</button>
      </div>
      <div id="reviewsList"></div>
    </div>
  </main>

  <main class="page" id="page-support">
    <div class="info-section">
      <h2 class="section-title">
        <svg style="width:32px;height:32px;stroke:var(--accent);fill:none;stroke-width:2" viewBox="0 0 24 24">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
        </svg>
        Support
      </h2>
      <a href="https://t.me/assistancenter" target="_blank" class="info-card">
        <div class="info-icon">
          <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </div>
        <span class="info-text">@assistancenter</span>
      </a>
      <p style="text-align:center;margin-top:30px;color:var(--text-muted)">Disponible 7j/7 pour vous aider 🕐</p>
    </div>
  </main>

  <nav class="bottom-nav">
    <button class="nav-item active" data-tab="home">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      <span class="nav-label">Accueil</span>
    </button>
    <button class="nav-item" data-tab="favorites">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
      <span class="nav-label">Favoris</span>
      <span class="nav-badge" id="badgeFavorites">0</span>
    </button>
    <button class="nav-item" id="cartNavBtn">
      <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
      <span class="nav-label">Panier</span>
      <span class="nav-badge" id="badgeBottom">0</span>
    </button>
    <button class="nav-item" data-tab="orders">
      <svg class="nav-icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
      <span class="nav-label">Commandes</span>
    </button>
    <button class="nav-item" data-tab="support">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
      <span class="nav-label">Support</span>
    </button>
  </nav>

  <section class="sheet hidden" id="productSheet">
    <div class="sheet-card">
      <div class="sheet-handle"></div>
      <div class="sheet-header">
        <h2 class="sheet-title" id="productTitle">Produit</h2>
        <button class="sheet-close" id="closeProduct">✕</button>
      </div>
      <div class="sheet-content" id="productContent"></div>
    </div>
  </section>

  <section class="sheet hidden" id="cartSheet">
    <div class="sheet-card">
      <div class="sheet-handle"></div>
      <div class="sheet-header">
        <h2 class="sheet-title">Mon panier</h2>
        <button class="sheet-close" id="closeCart">✕</button>
      </div>
      <div class="sheet-content" id="cartContent">
        <p style="text-align:center;color:var(--text-muted);padding:40px 20px">Votre panier est vide</p>
      </div>
      <div class="sheet-footer">
        <button class="btn-primary" id="validateOrder">Valider la commande</button>
      </div>
    </div>
  </section>

  <section class="sheet hidden" id="orderSummarySheet">
    <div class="sheet-card">
      <div class="sheet-handle"></div>
      <div class="sheet-header">
        <h2 class="sheet-title">✅ Commande confirmée</h2>
        <button class="sheet-close" id="closeOrderSummary">✕</button>
      </div>
      <div class="sheet-content" id="orderSummaryContent"></div>
      <div class="sheet-footer">
        <button class="btn-primary" id="closeOrderSummaryBtn" style="background:var(--bg-tertiary);color:var(--text-primary);box-shadow:none">
          Retour à l'accueil
        </button>
      </div>
    </div>
  </section>

  <script>
const PRODUCTS = [
  {id:1, name:"AMNESIA", farm:"coffee shop", video:"video/amnesia.MP4", category:"weed", 
   variants:[{label:"3,33G",grams:3.33,price:20},{label:"5G",grams:5,price:30},{label:"10G",grams:10,price:60},{label:"50G",grams:50,price:250},{label:"100G",grams:100,price:450}]},
  {id:2, name:"NEEDLES KETA", farm:"holland", video:"video/needles.MP4", category:"keta",
   variants:[{label:"1G",grams:1,price:20},{label:"2G",grams:2,price:40},{label:"3G",grams:3,price:50},{label:"5G",grams:5,price:80},{label:"10G",grams:10,price:150}]},
  {id:3, name:"CHAMPAGNE", farm:"hollande", video:"video/champagne.MP4", category:"mdma",
   variants:[{label:"1G",grams:1,price:20},{label:"2G",grams:2,price:40},{label:"3G",grams:3,price:50},{label:"5G",grams:5,price:80},{label:"10G",grams:10,price:150}]},
  {id:4, name:"EL JEFE", farm:"colombie", video:"video/el_jefe.MP4", category:"blanche",
   variants:[{label:"0,5G",grams:0.5,price:30},{label:"1G",grams:1,price:50},{label:"2G",grams:2,price:100},{label:"5G",grams:5,price:250},{label:"10G",grams:10,price:430}]},
  {id:5, name:"SKITTLEZ CAKE 120u", farm:"hash montaine", video:"video/skittlez_cake.MP4", category:"filtré",
   variants:[{label:"2,5G",grams:2.5,price:20},{label:"5G",grams:5,price:40},{label:"10G",grams:10,price:70},{label:"50G",grams:50,price:290}]},
  {id:6, name:"PISTACCHIO 73u", farm:"hash montaine", video:"video/pistacchio.MP4", category:"filtré",
   variants:[{label:"3G",grams:3,price:20},{label:"5G",grams:5,price:50},{label:"10G",grams:10,price:90},{label:"50G",grams:50,price:250}]},
  {id:7, name:"DEMBELE", farm:"morroco", video:"video/dembele.MP4", category:"mousseux",
   variants:[{label:"3,5G",grams:3.5,price:20},{label:"5G",grams:5,price:30},{label:"10G",grams:10,price:50},{label:"50G",grams:50,price:190},{label:"100G",grams:100,price:370}]},
  {id:8, name:"LEMON X GELATO", farm:"top shelf", video:"video/lemonxgelato.MP4", category:"cali",
   variants:[{label:"1,66G",grams:1.66,price:20},{label:"3,5G",grams:3.5,price:40},{label:"5G",grams:5,price:60},{label:"10G",grams:10,price:110}]},
  {id:9, name:"GEORGIA PIE", farm:"top shelf", video:"video/georgia_pie.MP4", category:"cali",
   variants:[{label:"1,66G",grams:1.66,price:20},{label:"3,5G",grams:3.5,price:40},{label:"5G",grams:5,price:60},{label:"10G",grams:10,price:110}]},
  {id:10, name:"DOMINO 280mg", farm:"holland", video:"video/domino.MP4", category:"bonbon",
   variants:[{label:"3 unités",grams:0,price:20},{label:"10 unités",grams:0,price:60},{label:"50 unités",grams:0,price:150}]},
  {id:11, name:"FRESH FROZEN", farm:"fresh", video:"video/fresh_frozen.MP4", category:"filtré",
   variants:[{label:"1,1G",grams:1.1,price:20},{label:"2,3G",grams:2.3,price:40},{label:"3,5G",grams:3.5,price:50},{label:"5G",grams:5,price:80},{label:"10G",grams:10,price:160}]},
  {id:12, name:"PURPLE HAZE", farm:"coffee shop", video:"video/purple.MP4", category:"weed",
   variants:[{label:"3,33G",grams:3.33,price:20},{label:"5G",grams:5,price:30},{label:"10G",grams:10,price:60},{label:"50G",grams:50,price:250},{label:"100G",grams:100,price:450}]}
];

const PROMO_CODES = {
  'WELCOME10': { type: 'percent', value: 10, label: '10% de réduction' },
  'FIRST20': { type: 'fixed', value: 20, label: '20€ de réduction' },
  'VIP15': { type: 'percent', value: 15, label: '15% de réduction VIP' }
};

// ✅ CORRECTION: Utiliser API_URL
const API_URL = 'https://drogua-backend-sxgy.onrender.com/api';
const fmt = n => n.toFixed(2) + ' €';

function sanitizeInput(input) {
  const div = document.createElement('div');
  div.textContent = input;
  return div.innerHTML;
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
}

function generateClientId() {
  return 'Client#' + Math.random().toString(36).substr(2, 6).toUpperCase();
}

function confirmDelete(message) {
  return new Promise((resolve) => {
    const dialog = document.createElement('div');
    dialog.className = 'confirm-dialog';
    dialog.innerHTML = `
      <div class="confirm-content">
        <p>${message}</p>
        <button id="confirmYes">Oui</button>
        <button id="confirmNo">Non</button>
      </div>
    `;
    document.body.appendChild(dialog);
    
    document.getElementById('confirmYes').onclick = () => {
      dialog.remove();
      resolve(true);
    };
    document.getElementById('confirmNo').onclick = () => {
      dialog.remove();
      resolve(false);
    };
  });
}

function showToast(msg) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerHTML = `<span class="toast-icon">✓</span><span class="toast-text">${msg}</span>`;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

const DataManager = {
  save(key, data) {
    try {
      if (typeof data === 'string') {
        localStorage.setItem(key, data);
      } else {
        localStorage.setItem(key, JSON.stringify(data));
      }
      return true;
    } catch (e) {
      console.error('Error saving data:', e);
      return false;
    }
  },
  
  load(key, defaultValue = null) {
    try {
      const data = localStorage.getItem(key);
      if (!data) return defaultValue;
      
      if (data.startsWith('{') || data.startsWith('[')) {
        return JSON.parse(data);
      }
      
      return data;
    } catch (e) {
      console.error('Error loading data:', e);
      return defaultValue;
    }
  },
  
  remove(key) {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (e) {
      console.error('Error removing data:', e);
      return false;
    }
  }
};

const CartManager = {
  items: [],
  
  init() {
    try {
      const loaded = DataManager.load('cart', []);
      this.items = Array.isArray(loaded) ? loaded : [];
    } catch (e) {
      console.error('Error loading cart:', e);
      this.items = [];
    }
  },
  
  add(item) {
    const existingIndex = this.items.findIndex(i => 
      i.productId === item.productId && i.variant === item.variant
    );
    
    if (existingIndex >= 0) {
      this.items[existingIndex].qty += item.qty;
    } else {
      this.items.push(item);
    }
    
    this.save();
    this.updateUI();
    return true;
  },
  
  remove(index) {
    if (index >= 0 && index < this.items.length) {
      this.items.splice(index, 1);
      this.save();
      this.updateUI();
      return true;
    }
    return false;
  },
  
  clear() {
    this.items = [];
    this.save();
    this.updateUI();
  },
  
  getTotal() {
    return this.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
  },
  
  getTotalItems() {
    return this.items.reduce((sum, item) => sum + item.qty, 0);
  },
  
  save() {
    DataManager.save('cart', this.items);
  },
  
  updateUI() {
    const total = this.getTotalItems();
    document.getElementById('badge').textContent = total;
    document.getElementById('badgeBottom').textContent = total;
  }
};

const FavoritesManager = {
  items: [],
  
  init() {
    try {
      const loaded = DataManager.load('favorites', []);
      this.items = Array.isArray(loaded) ? loaded : [];
    } catch (e) {
      console.error('Error loading favorites:', e);
      this.items = [];
    }
  },
  
  toggle(productId) {
    const index = this.items.indexOf(productId);
    
    if (index >= 0) {
      this.items.splice(index, 1);
      showToast('❌ Retiré des favoris');
    } else {
      this.items.push(productId);
      showToast('❤️ Ajouté aux favoris');
    }
    
    this.save();
    this.updateUI();
    return this.items.includes(productId);
  },
  
  has(productId) {
    return this.items.includes(productId);
  },
  
  save() {
    DataManager.save('favorites', this.items);
  },
  
  updateUI() {
    document.getElementById('badgeFavorites').textContent = this.items.length;
  }
};

const OrdersManager = {
  orders: [],
  
  init() {
    try {
      const loaded = DataManager.load('orders', []);
      this.orders = Array.isArray(loaded) ? loaded : [];
    } catch (e) {
      console.error('Error loading orders:', e);
      this.orders = [];
    }
  },
  
  add(order) {
    this.orders.push(order);
    this.save();
  },
  
  getAll() {
    return this.orders.slice().reverse();
  },
  
  save() {
    DataManager.save('orders', this.orders);
  }
};

const LoyaltyManager = {
  totalOrders: 0,
  orderHistory: [],
  
  init() {
    try {
      this.totalOrders = parseInt(DataManager.load('loyaltyTotalOrders', 0)) || 0;
      const loaded = DataManager.load('loyaltyHistory', []);
      this.orderHistory = Array.isArray(loaded) ? loaded : [];
    } catch (e) {
      console.error('Error loading loyalty:', e);
      this.totalOrders = 0;
      this.orderHistory = [];
    }
    this.updateUI();
  },
  
  addOrder(orderId, amount) {
    this.totalOrders++;
    this.orderHistory.push({
      id: orderId,
      date: new Date().toISOString(),
      amount: amount,
      orderNumber: this.totalOrders
    });
    
    this.save();
    this.updateUI();
    
    if (this.totalOrders % 10 === 0) {
      return { hasReward: true, discount: Math.min(amount * 0.1, 20) };
    }
    
    return { hasReward: false, discount: 0 };
  },
  
  getCurrentProgress() {
    return this.totalOrders % 10;
  },
  
  getNextRewardIn() {
    return 10 - (this.totalOrders % 10);
  },
  
  save() {
    DataManager.save('loyaltyTotalOrders', this.totalOrders);
    DataManager.save('loyaltyHistory', this.orderHistory);
  },
  
  updateUI() {
    const progress = this.getCurrentProgress();
    const remaining = this.getNextRewardIn();
    const progressPercent = (progress / 10) * 100;
    
    const title = remaining === 10 
      ? 'Programme fidélité actif !'
      : `Plus que ${remaining} commande${remaining > 1 ? 's' : ''} !`;
    
    document.getElementById('loyaltyTitle').textContent = title;
    document.getElementById('loyaltySubtitle').textContent = `${progress}/10 commandes`;
    document.getElementById('loyaltyBar').style.width = progressPercent + '%';
  },
  
  renderDetails() {
    const details = document.getElementById('loyaltyDetails');
    
    const nextReward = this.getNextRewardIn();
    const progress = this.getCurrentProgress();
    
    let html = `
      <div style="background:linear-gradient(135deg,rgba(0,212,255,0.2) 0%,rgba(118,75,162,0.2) 100%);border:2px solid var(--accent);border-radius:20px;padding:30px;margin-bottom:24px;text-align:center">
        <div style="font-size:48px;margin-bottom:16px">🎁</div>
        <h3 style="font-size:24px;font-weight:800;margin-bottom:12px">Programme Fidélité</h3>
        <p style="color:var(--text-secondary);font-size:16px;margin-bottom:20px">
          Commandez 10 fois et recevez une remise automatique !
        </p>
        
        <div style="background:var(--bg-secondary);border-radius:16px;padding:20px;margin-bottom:20px">
          <div style="display:flex;justify-content:space-between;margin-bottom:12px">
            <span style="color:var(--text-secondary)">Progression</span>
            <span style="font-weight:700;color:var(--accent)">${progress}/10</span>
          </div>
          <div style="width:100%;height:12px;background:var(--bg-tertiary);border-radius:6px;overflow:hidden">
            <div style="height:100%;background:linear-gradient(90deg,var(--accent) 0%,#764ba2 100%);width:${(progress/10)*100}%;transition:width 0.5s"></div>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
          <div style="background:var(--bg-secondary);border-radius:12px;padding:16px">
            <div style="font-size:32px;font-weight:800;color:var(--accent)">${this.totalOrders}</div>
            <div style="color:var(--text-muted);font-size:13px">Commandes totales</div>
          </div>
          <div style="background:var(--bg-secondary);border-radius:12px;padding:16px">
            <div style="font-size:32px;font-weight:800;color:var(--accent)">${nextReward}</div>
            <div style="color:var(--text-muted);font-size:13px">Avant récompense</div>
          </div>
        </div>
      </div>
      
      <h3 style="font-size:20px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px">
        📜 Historique des commandes
      </h3>
    `;
    
    if (this.orderHistory.length === 0) {
      html += '<div style="text-align:center;color:var(--text-muted);padding:40px">Aucune commande pour le moment</div>';
    } else {
      html += this.orderHistory.slice().reverse().map((order, idx) => {
        const isReward = order.orderNumber % 10 === 0;
        return `
          <div class="info-card" style="flex-direction:column;align-items:flex-start;position:relative;${isReward ? 'border-color:var(--success);background:rgba(16,185,129,0.05)' : ''}">
            ${isReward ? '<div style="position:absolute;top:12px;right:12px;background:var(--success);color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:700">🎁 RÉCOMPENSE</div>' : ''}
            <div style="display:flex;justify-content:space-between;width:100%;margin-bottom:8px">
              <strong style="color:var(--accent)">Commande #${order.orderNumber}</strong>
              <span style="color:var(--text-muted);font-size:13px">${new Date(order.date).toLocaleDateString('fr-FR')}</span>
            </div>
            <div style="font-size:18px;font-weight:700;color:var(--accent)">${fmt(order.amount)}</div>
            <div style="color:var(--text-muted);font-size:13px;margin-top:4px">ID: ${order.id}</div>
          </div>
        `;
      }).join('');
    }
    
    details.innerHTML = html;
  }
};

const ReviewsManager = {
  reviews: [],
  
  init() {
    try {
      const loaded = DataManager.load('reviews', []);
      this.reviews = Array.isArray(loaded) ? loaded : [];
    } catch (e) {
      console.error('Error loading reviews:', e);
      this.reviews = [];
    }
  },
  
  add(review) {
    review.date = new Date().toISOString();
    this.reviews.unshift(review);
    this.save();
  },
  
  getAll() {
    const demoReviews = [
      {name: 'Martin D.', stars: 5, text: 'Excellent service, produits de qualité !', date: new Date(Date.now() - 2*24*60*60*1000).toISOString()},
      {name: 'Sophie L.', stars: 5, text: 'Livraison rapide et discrète, je recommande', date: new Date(Date.now() - 5*24*60*60*1000).toISOString()},
      {name: 'Thomas B.', stars: 4, text: 'Très satisfait de ma commande', date: new Date(Date.now() - 7*24*60*60*1000).toISOString()}
    ];
    
    return [...this.reviews, ...demoReviews];
  },
  
  save() {
    DataManager.save('reviews', this.reviews);
  }
};

const RateLimiter = {
  attempts: {},
  
  canProceed(key, maxAttempts = 5, timeWindow = 60000) {
    const now = Date.now();
    if (!this.attempts[key]) {
      this.attempts[key] = [];
    }
    
    this.attempts[key] = this.attempts[key].filter(
      time => now - time < timeWindow
    );
    
    if (this.attempts[key].length >= maxAttempts) {
      return false;
    }
    
    this.attempts[key].push(now);
    return true;
  }
};

const VideoObserver = {
  observer: null,
  
  init() {
    const options = {
      root: null,
      rootMargin: '50px',
      threshold: 0.1
    };
    
    this.observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const video = entry.target;
        if (entry.isIntersecting) {
          if (video.paused) video.play().catch(() => {});
        } else {
          video.pause();
        }
      });
    }, options);
  },
  
  observe(video) {
    if (this.observer) {
      this.observer.observe(video);
    }
  }
};

let currentProduct = null;
let selectedVariant = null;
let quantity = 1;
let selectedDelivery = 'millau';
let currentSort = 'default';
let currentCategory = 'all';
let appliedPromo = null;

function initTheme() {
  const theme = DataManager.load('theme', 'dark');
  document.body.setAttribute('data-theme', theme);
  updateThemeIcon(theme);
}

function toggleTheme() {
  const current = document.body.getAttribute('data-theme') || 'dark';
  const newTheme = current === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', newTheme);
  DataManager.save('theme', newTheme);
  updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
  const icon = document.getElementById('themeIcon');
  if (theme === 'light') {
    icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
  } else {
    icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
  }
}

function sortProducts(products, sortType) {
  const sorted = [...products];
  switch(sortType) {
    case 'price-asc':
      sorted.sort((a, b) => Math.min(...a.variants.map(v => v.price)) - Math.min(...b.variants.map(v => v.price)));
      break;
    case 'price-desc':
      sorted.sort((a, b) => Math.min(...b.variants.map(v => v.price)) - Math.min(...a.variants.map(v => v.price)));
      break;
    case 'name':
      sorted.sort((a, b) => a.name.localeCompare(b.name));
      break;
  }
  return sorted;
}

function renderProducts(filter = 'all', sort = 'default') {
  currentCategory = filter;
  currentSort = sort;
  
  const grid = document.getElementById('productGrid');
  let filtered = filter === 'all' ? PRODUCTS : PRODUCTS.filter(p => p.category === filter);
  const sorted = sortProducts(filtered, sort);
  
  document.getElementById('resultsCount').textContent = `${sorted.length} articles`;
  
  grid.innerHTML = sorted.map(p => {
    const minPrice = Math.min(...p.variants.map(v => v.price));
    const isFav = FavoritesManager.has(p.id);
    return `
    <div class="product-card" data-id="${p.id}">
      <div class="product-thumb">
        <video class="product-video" muted loop playsinline preload="none">
          <source src="${p.video}" type="video/mp4">
        </video>
        <div class="product-rating"><span>⭐</span><span>4.8</span></div>
        <div class="product-actions">
          <button class="product-action-btn ${isFav ? 'active' : ''}" data-fav="${p.id}">
            <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
          </button>
          <button class="product-action-btn" data-share="${p.id}">
            <svg viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
          </button>
        </div>
      </div>
      <div class="product-meta">
        <div class="product-farm">${sanitizeInput(p.farm)}</div>
        <div class="product-name">${sanitizeInput(p.name)}</div>
        <div class="product-price">
          <span class="price-from">À partir de</span>
          <span class="price-amount">${fmt(minPrice)}</span>
        </div>
      </div>
    </div>
  `}).join('');
  
  grid.querySelectorAll('.product-video').forEach(video => {
    VideoObserver.observe(video);
  });
  
  grid.querySelectorAll('.product-card').forEach(card => {
    card.onclick = (e) => {
      if (!e.target.closest('.product-action-btn')) {
        openProduct(parseInt(card.dataset.id));
      }
    };
  });
  
  grid.querySelectorAll('[data-fav]').forEach(btn => {
    btn.onclick = (e) => {
      e.stopPropagation();
      const productId = parseInt(btn.dataset.fav);
      FavoritesManager.toggle(productId);
      renderProducts(currentCategory, currentSort);
      renderFavorites();
    };
  });
  
  grid.querySelectorAll('[data-share]').forEach(btn => {
    btn.onclick = (e) => {
      e.stopPropagation();
      const productId = parseInt(btn.dataset.share);
      const product = PRODUCTS.find(p => p.id === productId);
      shareProduct(product);
    };
  });
}

function shareProduct(product) {
  const text = `🔥 Découvrez ${product.name} sur DROGUA CENTER !\n\nÀ partir de ${fmt(Math.min(...product.variants.map(v => v.price)))}\n\n👉 https://t.me/+MToYP95G9zY2ZTJk`;
  
  if (navigator.share) {
    navigator.share({
      title: product.name,
      text: text
    }).catch(() => {
      navigator.clipboard.writeText(text).then(() => {
        showToast('📋 Lien copié !');
      });
    });
  } else {
    navigator.clipboard.writeText(text).then(() => {
      showToast('📋 Lien copié !');
    });
  }
}

const searchProducts = debounce((query) => {
  if (query.length < 2) {
    renderProducts(currentCategory, currentSort);
    return;
  }
  
  const filtered = PRODUCTS.filter(p => 
    p.name.toLowerCase().includes(query) || 
    p.farm.toLowerCase().includes(query) ||
    p.category.toLowerCase().includes(query)
  );
  
  const sorted = sortProducts(filtered, currentSort);
  const grid = document.getElementById('productGrid');
  
  document.getElementById('resultsCount').textContent = `${sorted.length} articles`;
  
  grid.innerHTML = sorted.map(p => {
    const minPrice = Math.min(...p.variants.map(v => v.price));
    const isFav = FavoritesManager.has(p.id);
    return `
    <div class="product-card" data-id="${p.id}">
      <div class="product-thumb">
        <video class="product-video" muted loop playsinline preload="none">
          <source src="${p.video}" type="video/mp4">
        </video>
        <div class="product-rating"><span>⭐</span><span>4.8</span></div>
        <div class="product-actions">
          <button class="product-action-btn ${isFav ? 'active' : ''}" data-fav="${p.id}">
            <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
          </button>
        </div>
      </div>
      <div class="product-meta">
        <div class="product-farm">${sanitizeInput(p.farm)}</div>
        <div class="product-name">${sanitizeInput(p.name)}</div>
        <div class="product-price">
          <span class="price-from">À partir de</span>
          <span class="price-amount">${fmt(minPrice)}</span>
        </div>
      </div>
    </div>
  `}).join('');
  
  grid.querySelectorAll('.product-video').forEach(video => {
    VideoObserver.observe(video);
  });
  
  grid.querySelectorAll('.product-card').forEach(card => {
    card.onclick = (e) => {
      if (!e.target.closest('.product-action-btn')) {
        openProduct(parseInt(card.dataset.id));
      }
    };
  });
  
  grid.querySelectorAll('[data-fav]').forEach(btn => {
    btn.onclick = (e) => {
      e.stopPropagation();
      FavoritesManager.toggle(parseInt(btn.dataset.fav));
      renderProducts(currentCategory, currentSort);
      renderFavorites();
    };
  });
}, 300);

function openProduct(id) {
  currentProduct = PRODUCTS.find(p => p.id === id);
  selectedVariant = null;
  quantity = 1;
  
  document.getElementById('productTitle').textContent = currentProduct.name;
  
  const content = document.getElementById('productContent');
  content.innerHTML = `
    <div class="product-image">
      <video class="product-image-video" autoplay muted loop playsinline>
        <source src="${currentProduct.video}" type="video/mp4">
      </video>
    </div>
    <div class="product-detail-header">
      <div class="product-detail-farm">${sanitizeInput(currentProduct.farm)}</div>
      <h2 class="product-detail-name">${sanitizeInput(currentProduct.name)}</h2>
      <div class="product-detail-rating">
        <span style="color:#facc15;font-size:20px">⭐</span>
        <span style="font-size:18px;font-weight:700">4.8</span>
        <span style="color:var(--text-muted)">(127 avis)</span>
      </div>
    </div>
    <div class="variants-section">
      <div class="variants-title">Sélectionnez une taille :</div>
      ${currentProduct.variants.map((v, idx) => `
        <div class="variant-option" data-idx="${idx}">
          <div>
            <div class="variant-label">${sanitizeInput(v.label)}</div>
            <div class="variant-grams">${v.grams ? v.grams + ' grammes' : 'Unités'}</div>
          </div>
          <div class="variant-price">${fmt(v.price)}</div>
        </div>
      `).join('')}
    </div>
    <div class="qty-selector" id="qtySelector" style="display:none">
      <span class="qty-label">Quantité :</span>
      <div class="qty-controls">
        <button class="qty-btn" id="qtyMinus">−</button>
        <span class="qty-display" id="qtyDisplay">1</span>
        <button class="qty-btn" id="qtyPlus">+</button>
      </div>
    </div>
    <div class="add-to-cart-bar" id="addToCartBar" style="display:none">
      <div class="price-info">
        <div class="price-label">Total</div>
        <div class="price-value" id="totalPrice">0,00 €</div>
      </div>
      <button class="add-btn" id="addToCart">
        <span>Ajouter au panier</span>
        <span>🛒</span>
      </button>
    </div>
  `;
  
  content.querySelectorAll('.variant-option').forEach(opt => {
    opt.onclick = function() {
      content.querySelectorAll('.variant-option').forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      selectedVariant = currentProduct.variants[parseInt(this.dataset.idx)];
      quantity = 1;
      document.getElementById('qtyDisplay').textContent = '1';
      document.getElementById('qtySelector').style.display = 'flex';
      document.getElementById('addToCartBar').style.display = 'flex';
      updateTotalPrice();
    };
  });
  
  content.querySelector('#qtyMinus').onclick = () => {
    if (quantity > 1) {
      quantity--;
      document.getElementById('qtyDisplay').textContent = quantity;
      updateTotalPrice();
    }
  };
  
  content.querySelector('#qtyPlus').onclick = () => {
    if (quantity < 99) {
      quantity++;
      document.getElementById('qtyDisplay').textContent = quantity;
      updateTotalPrice();
    }
  };
  
  content.querySelector('#addToCart').onclick = () => {
    if (selectedVariant) {
      const cartItem = {
        productId: currentProduct.id,
        name: currentProduct.name,
        variant: selectedVariant.label,
        price: selectedVariant.price,
        qty: quantity,
        video: currentProduct.video
      };
      
      CartManager.add(cartItem);
      showToast(`✅ ${quantity}x ${currentProduct.name} ajouté au panier`);
      closeProduct();
    }
  };
  
  document.getElementById('productSheet').classList.remove('hidden');
  document.body.classList.add('modal-open');
}

function updateTotalPrice() {
  if (selectedVariant) {
    const total = selectedVariant.price * quantity;
    document.getElementById('totalPrice').textContent = fmt(total);
  }
}

function closeProduct() {
  document.getElementById('productSheet').classList.add('hidden');
  document.body.classList.remove('modal-open');
}

function validateAddress(address) {
  if (!address || address.length < 5) {
    return { valid: false, error: 'Adresse trop courte (minimum 5 caractères)' };
  }
  
  const hasNumber = /\d/.test(address);
  const hasStreet = /rue|avenue|boulevard|place|allée|impasse|chemin|route|voie/i.test(address);
  
  if (!hasNumber) {
    return { valid: false, error: 'L\'adresse doit contenir un numéro' };
  }
  
  if (!hasStreet) {
    return { valid: false, error: 'Format d\'adresse invalide (ex: 12 Rue de la Paix, Millau)' };
  }
  
  return { valid: true };
}

function renderCart() {
  const content = document.getElementById('cartContent');
  
  if (CartManager.items.length === 0) {
    content.innerHTML = `
      <div class="cart-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        <p>Votre panier est vide</p>
      </div>
    `;
    return;
  }
  
  const subtotal = CartManager.getTotal();
  const deliveryFee = selectedDelivery === 'exterieur' ? 20 : 0;
  let discount = 0;
  
  if (appliedPromo) {
    if (appliedPromo.type === 'percent') {
      discount = subtotal * (appliedPromo.value / 100);
    } else {
      discount = appliedPromo.value;
    }
  }
  
  const total = subtotal + deliveryFee - discount;
  
  content.innerHTML = `
    ${CartManager.items.map((item, idx) => `
      <div class="cart-item">
        <div class="cart-item-image">
          <video class="cart-item-video" autoplay muted loop playsinline>
            <source src="${item.video}" type="video/mp4">
          </video>
        </div>
        <div class="cart-item-info">
          <div class="cart-item-name">${sanitizeInput(item.name)}</div>
          <div class="cart-item-variant">${sanitizeInput(item.variant)} × ${item.qty}</div>
          <div class="cart-item-price">${fmt(item.price * item.qty)}</div>
        </div>
        <div class="cart-item-actions">
          <button class="delete-btn" data-idx="${idx}">🗑️</button>
        </div>
      </div>
    `).join('')}
    
    <div class="promo-section">
      <div class="section-label">Code promo</div>
      ${appliedPromo ? `
        <div class="promo-applied">
          <span class="promo-applied-text">
            <svg style="width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2" viewBox="0 0 24 24">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            ${appliedPromo.label}
          </span>
          <button class="promo-remove" id="removePromo">✕</button>
        </div>
      ` : `
        <div class="promo-input-wrapper">
          <input type="text" class="promo-input" id="promoInput" placeholder="Entrez votre code" maxlength="20">
          <button class="promo-btn" id="applyPromo">Appliquer</button>
        </div>
      `}
    </div>
    
    <div class="delivery-section">
      <div class="section-label">Mode de livraison</div>
      <div class="delivery-options">
        <div class="delivery-option ${selectedDelivery === 'millau' ? 'selected' : ''}" data-delivery="millau">
          <div class="delivery-info">
            <div class="delivery-title">📍 Livraison sur Millau</div>
            <div class="delivery-price">Gratuit</div>
          </div>
        </div>
        <div class="delivery-option ${selectedDelivery === 'exterieur' ? 'selected' : ''}" data-delivery="exterieur">
          <div class="delivery-info">
            <div class="delivery-title">🚚 Livraison extérieure</div>
            <div class="delivery-price">+20,00 €</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="anonymous-info">
      <div class="anonymous-icon">🎭</div>
      <div class="anonymous-text">
        <div class="anonymous-title">Commande 100% anonyme</div>
        <div class="anonymous-subtitle">
          • Aucune donnée personnelle enregistrée<br>
          • Communication via notre bot sécurisé<br>
          • Paiement en espèces à la livraison
        </div>
      </div>
    </div>
    
    <div class="address-section">
      <div class="section-label">📍 Adresse de livraison</div>
      <div class="input-wrapper">
        <input type="text" class="input-field" id="addressInput" placeholder="Entrez votre adresse..." maxlength="200">
        <div class="suggestions" id="suggestions" style="display:none"></div>
      </div>
    </div>
    
    <div class="cart-total">
      <div>
        <div style="color:var(--text-muted);font-size:14px;margin-bottom:4px">Sous-total : ${fmt(subtotal)}</div>
        ${deliveryFee > 0 ? `<div style="color:var(--text-muted);font-size:14px">Livraison : ${fmt(deliveryFee)}</div>` : ''}
        ${discount > 0 ? `<div style="color:var(--success);font-size:14px">Réduction : -${fmt(discount)}</div>` : ''}
      </div>
      <span class="total-amount">${fmt(total)}</span>
    </div>
  `;
  
  content.querySelectorAll('.delete-btn').forEach(btn => {
    btn.onclick = async () => {
      const idx = parseInt(btn.dataset.idx);
      const confirmed = await confirmDelete('Retirer cet article du panier ?');
      if (confirmed) {
        CartManager.remove(idx);
        renderCart();
        showToast('Article retiré du panier');
      }
    };
  });
  
  content.querySelectorAll('.delivery-option').forEach(opt => {
    opt.onclick = function() {
      selectedDelivery = this.dataset.delivery;
      renderCart();
    };
  });
  
  const applyBtn = content.querySelector('#applyPromo');
  if (applyBtn) {
    applyBtn.onclick = () => {
      const input = content.querySelector('#promoInput');
      const code = input.value.trim().toUpperCase();
      
      if (!RateLimiter.canProceed('promo', 5, 60000)) {
        showToast('⚠️ Trop de tentatives. Attendez 1 minute.');
        return;
      }
      
      if (PROMO_CODES[code]) {
        appliedPromo = PROMO_CODES[code];
        showToast(`🎉 Code "${code}" appliqué !`);
        renderCart();
      } else {
        input.classList.add('invalid');
        showToast('❌ Code promo invalide');
        setTimeout(() => input.classList.remove('invalid'), 2000);
      }
    };
  }
  
  const removeBtn = content.querySelector('#removePromo');
  if (removeBtn) {
    removeBtn.onclick = () => {
      appliedPromo = null;
      showToast('Code promo retiré');
      renderCart();
    };
  }
  
  const addressInput = content.querySelector('#addressInput');
  let timer = null;
  
  const frenchCities = [
    'Paris 75000', 'Marseille 13000', 'Lyon 69000', 'Toulouse 31000',
    'Nice 06000', 'Nantes 44000', 'Montpellier 34000', 'Strasbourg 67000',
    'Bordeaux 33000', 'Lille 59000', 'Rennes 35000', 'Reims 51100',
    'Millau 12100', 'Rodez 12000', 'Albi 81000'
  ];
  
  const streetTypes = [
    'Rue', 'Avenue', 'Boulevard', 'Place', 'Allée', 'Impasse', 
    'Chemin', 'Route', 'Voie', 'Square', 'Cours', 'Quai'
  ];
  
  addressInput.addEventListener('input', (e) => {
    clearTimeout(timer);
    const query = sanitizeInput(e.target.value.trim().toLowerCase());
    
    if (query.length < 2) {
      content.querySelector('#suggestions').style.display = 'none';
      return;
    }
    
    timer = setTimeout(() => {
      const suggestions = [];
      
      const matchingCities = frenchCities.filter(city => 
        city.toLowerCase().includes(query)
      );
      
      const numberMatch = query.match(/^(\d+)\s*([a-zéèêë]*)/i);
      if (numberMatch) {
        const number = numberMatch[1];
        const partial = numberMatch[2];
        
        streetTypes.forEach(type => {
          if (!partial || type.toLowerCase().startsWith(partial)) {
            matchingCities.slice(0, 3).forEach(city => {
              suggestions.push(`${number} ${type} de la République, ${city}`);
            });
          }
        });
      } else {
        matchingCities.slice(0, 5).forEach(city => {
          suggestions.push(`Adresse à ${city}`);
        });
      }
      
      if (suggestions.length > 0) {
        const suggestionsEl = content.querySelector('#suggestions');
        suggestionsEl.innerHTML = suggestions.slice(0, 5).map(addr => 
          `<div class="suggestion-item" data-address="${sanitizeInput(addr)}">${sanitizeInput(addr)}</div>`
        ).join('');
        suggestionsEl.style.display = 'block';
        
        suggestionsEl.querySelectorAll('.suggestion-item').forEach(item => {
          item.onclick = function() {
            const addr = this.dataset.address;
            if (addr.startsWith('Adresse à ')) {
              const city = addr.replace('Adresse à ', '');
              addressInput.value = '';
              addressInput.placeholder = `Tapez votre adresse à ${city}...`;
              addressInput.focus();
            } else {
              addressInput.value = addr;
            }
            suggestionsEl.style.display = 'none';
          };
        });
      } else {
        content.querySelector('#suggestions').style.display = 'none';
      }
    }, 200);
  });
  
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.input-wrapper')) {
      const suggestionsEl = content.querySelector('#suggestions');
      if (suggestionsEl) suggestionsEl.style.display = 'none';
    }
  });
}

function openCart() {
  renderCart();
  document.getElementById('cartSheet').classList.remove('hidden');
  document.body.classList.add('modal-open');
}

// ✅ FONCTION CORRIGÉE avec API_URL
async function validateOrder() {
  if (CartManager.items.length === 0) {
    showToast('⚠️ Votre panier est vide');
    return;
  }
  
  if (!RateLimiter.canProceed('order', 3, 300000)) {
    showToast('⚠️ Trop de tentatives. Attendez 5 minutes.');
    return;
  }
  
  const addressInput = document.getElementById('addressInput');
  const address = addressInput?.value.trim() || '';
  
  const validation = validateAddress(address);
  if (!validation.valid) {
    showToast(`⚠️ ${validation.error}`);
    if (addressInput) addressInput.focus();
    return;
  }
  
  const btn = document.getElementById('validateOrder');
  btn.disabled = true;
  btn.classList.add('loading');
  btn.textContent = 'Validation en cours...';
  
  try {
    const clientId = generateClientId();
    const deliveryType = selectedDelivery === 'millau' 
      ? 'Livraison sur Millau' 
      : 'Livraison extérieure (+20€)';
    
    const items = CartManager.items.map(item => ({
      product_id: item.productId,
      name: item.name,
      variant: item.variant,
      qty: item.qty,
      price: item.price,
      lineTotal: item.price * item.qty
    }));
    
    const subtotal = CartManager.getTotal();
    const deliveryFee = selectedDelivery === 'exterieur' ? 20 : 0;
    
    let promoDiscount = 0;
    if (appliedPromo) {
      if (appliedPromo.type === 'percent') {
        promoDiscount = subtotal * (appliedPromo.value / 100);
      } else {
        promoDiscount = appliedPromo.value;
      }
    }
    
    const subtotalWithDelivery = subtotal + deliveryFee;
    
    const nextOrderNumber = LoyaltyManager.totalOrders + 1;
    const willGetReward = nextOrderNumber % 10 === 0;
    let loyaltyDiscount = 0;
    
    if (willGetReward) {
      loyaltyDiscount = Math.min(subtotalWithDelivery * 0.1, 20);
      showToast('🎁 Félicitations ! Remise fidélité appliquée !');
    }
    
    const totalDiscount = promoDiscount + loyaltyDiscount;
    const total = subtotalWithDelivery - totalDiscount;
    
    const orderData = {
      customer: clientId,
      type: deliveryType,
      address: address,
      items: items,
      total: total
    };
    
    // ✅ UTILISER API_URL (correction appliquée)
    console.log('🔄 Envoi vers:', API_URL + '/create-order');
    
    const response = await fetch(API_URL + '/create-order', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(orderData)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.ok) {
      const orderId = data.orderId;
      
      const order = {
        id: orderId,
        date: new Date().toISOString(),
        items: items,
        itemCount: CartManager.getTotalItems(),
        total: total,
        status: 'pending'
      };
      
      OrdersManager.add(order);
      LoyaltyManager.addOrder(orderId, total);
      
      // Sauvegarder pour l'admin
      const shopOrders = JSON.parse(localStorage.getItem('shop_orders') || '[]');
      shopOrders.push({
        id: orderId,
        timestamp: new Date().toISOString(),
        name: orderData.customer,
        items: orderData.items.map(item => ({
          name: item.name,
          variant: item.variant,
          quantity: item.qty,
          price: item.price
        })),
        total: total,
        paymentMethod: 'Espèces',
        email: '',
        phone: '',
        deliveryAddress: orderData.address,
        deliveryType: orderData.type
      });
      localStorage.setItem('shop_orders', JSON.stringify(shopOrders));
      
      CartManager.clear();
      appliedPromo = null;
      
      document.getElementById('cartSheet').classList.add('hidden');
      showOrderSummary(orderData, orderId, totalDiscount);
      
      console.log('✅ Commande créée:', orderId);
      
    } else {
      throw new Error(data.error || 'Erreur inconnue');
    }
    
  } catch (error) {
    console.error('❌ Erreur:', error);
    
    if (error.message.includes('Failed to fetch')) {
      showToast('❌ Impossible de contacter le serveur.');
    } else {
      showToast('❌ Erreur lors de la validation. Réessayez.');
    }
  } finally {
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.textContent = 'Valider la commande';
  }
}

function showOrderSummary(orderData, orderId, discount = 0) {
  const content = document.getElementById('orderSummaryContent');
  const deliveryFee = orderData.type.includes('+20') ? 20 : 0;
  const subtotal = orderData.items.reduce((sum, item) => sum + item.lineTotal, 0);
  const totalWithDiscount = orderData.total;
  
  content.innerHTML = `
    <div style="text-align:center;padding:20px 0">
      <div style="width:80px;height:80px;background:var(--success);border-radius:50%;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;animation:scaleIn 0.5s ease">
        <svg style="width:40px;height:40px;stroke:#fff;fill:none;stroke-width:3" viewBox="0 0 24 24">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <h3 style="font-size:24px;font-weight:700;margin-bottom:8px;color:var(--success)">Commande confirmée !</h3>
      <p style="color:var(--text-secondary);font-size:16px">Numéro de commande : <strong style="color:var(--accent)">#${orderId}</strong></p>
    </div>
    
    <div style="background:var(--bg-tertiary);border-radius:16px;padding:20px;margin:20px 0">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
        <div style="width:40px;height:40px;background:rgba(0,212,255,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center">
          <svg style="width:20px;height:20px;stroke:var(--accent);fill:none;stroke-width:2" viewBox="0 0 24 24">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div style="flex:1">
          <div style="color:var(--text-muted);font-size:13px;margin-bottom:2px">Référence client</div>
          <div style="font-weight:600">🎭 ${sanitizeInput(orderData.customer)}</div>
        </div>
      </div>
      
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
        <div style="width:40px;height:40px;background:rgba(0,212,255,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center">
          <svg style="width:20px;height:20px;stroke:var(--accent);fill:none;stroke-width:2" viewBox="0 0 24 24">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
        </div>
        <div style="flex:1">
          <div style="color:var(--text-muted);font-size:13px;margin-bottom:2px">Adresse de livraison</div>
          <div style="font-weight:600">${sanitizeInput(orderData.address)}</div>
        </div>
      </div>
      
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:40px;height:40px;background:rgba(0,212,255,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center">
          <svg style="width:20px;height:20px;stroke:var(--accent);fill:none;stroke-width:2" viewBox="0 0 24 24">
            <rect x="1" y="3" width="15" height="13"></rect>
            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
            <circle cx="5.5" cy="18.5" r="2.5"></circle>
            <circle cx="18.5" cy="18.5" r="2.5"></circle>
          </svg>
        </div>
        <div style="flex:1">
          <div style="color:var(--text-muted);font-size:13px;margin-bottom:2px">Mode de livraison</div>
          <div style="font-weight:600">${orderData.type}</div>
        </div>
      </div>
    </div>
    
    <div style="margin:20px 0">
      <h4 style="font-size:18px;font-weight:700;margin-bottom:16px">Articles commandés</h4>
      ${orderData.items.map(item => `
        <div style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:600;margin-bottom:4px">${sanitizeInput(item.name)}</div>
            <div style="color:var(--text-muted);font-size:13px">${sanitizeInput(item.variant)} × ${item.qty}</div>
          </div>
          <div style="font-size:18px;font-weight:700;color:var(--accent)">${fmt(item.lineTotal)}</div>
        </div>
      `).join('')}
    </div>
    
    <div style="background:linear-gradient(135deg,rgba(0,212,255,0.1) 0%,rgba(118,75,162,0.1) 100%);border:2px solid var(--accent);border-radius:16px;padding:20px;margin:20px 0">
      <div style="display:flex;justify-content:space-between;margin-bottom:12px">
        <span style="color:var(--text-secondary)">Sous-total</span>
        <span style="font-weight:600">${fmt(subtotal)}</span>
      </div>
      ${deliveryFee > 0 ? `
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span style="color:var(--text-secondary)">Frais de livraison</span>
          <span style="font-weight:600">${fmt(deliveryFee)}</span>
        </div>
      ` : ''}
      ${discount > 0 ? `
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span style="color:var(--success)">🎁 Remise</span>
          <span style="font-weight:600;color:var(--success)">-${fmt(discount)}</span>
        </div>
      ` : ''}
      <div style="border-top:2px solid var(--accent);margin:12px 0;padding-top:12px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:20px;font-weight:700">Total</span>
        <span style="font-size:28px;font-weight:800;color:var(--accent)">${fmt(totalWithDiscount)}</span>
      </div>
    </div>
    
    <div style="background:var(--bg-tertiary);border-left:4px solid var(--accent);border-radius:12px;padding:16px;margin:20px 0">
      <div style="display:flex;align-items:start;gap:12px">
        <svg style="width:24px;height:24px;stroke:var(--accent);fill:none;stroke-width:2;flex-shrink:0;margin-top:2px" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div>
          <div style="font-weight:600;margin-bottom:8px;font-size:16px">Prochaines étapes</div>
          <ul style="color:var(--text-secondary);font-size:14px;line-height:1.8;padding-left:20px;margin:0">
            <li>Notre équipe va vérifier votre commande</li>
            <li>Le livreur vous contactera via notre bot sécurisé</li>
            <li>Communication 100% anonyme garantie</li>
            <li>Paiement à la livraison (espèces uniquement)</li>
            <li>Livraison rapide et discrète</li>
          </ul>
        </div>
      </div>
    </div>
    
    <div style="text-align:center;margin-top:30px">
      <p style="color:var(--text-muted);font-size:14px;margin-bottom:16px">Une question ? Contactez notre support anonyme</p>
      <a href="https://t.me/assistancenter" target="_blank" style="display:inline-flex;align-items:center;gap:8px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:12px;padding:12px 20px;color:var(--accent);text-decoration:none;font-weight:600;transition:all 0.2s">
        <svg style="width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2" viewBox="0 0 24 24">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
        @assistancenter
      </a>
    </div>
  `;
  
  document.getElementById('orderSummarySheet').classList.remove('hidden');
  document.body.classList.add('modal-open');
}

function renderFavorites() {
  const list = document.getElementById('favoritesList');
  
  if (FavoritesManager.items.length === 0) {
    list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px">Aucun favori pour le moment</div>';
    return;
  }
  
  const favProducts = PRODUCTS.filter(p => FavoritesManager.items.includes(p.id));
  list.innerHTML = favProducts.map(p => {
    const minPrice = Math.min(...p.variants.map(v => v.price));
    return `
      <div class="info-card" style="cursor:pointer" data-product-id="${p.id}">
        <div style="width:60px;height:60px;border-radius:12px;overflow:hidden;flex-shrink:0;background:var(--bg-tertiary)">
          <video style="width:100%;height:100%;object-fit:cover" autoplay muted loop playsinline>
            <source src="${p.video}" type="video/mp4">
          </video>
        </div>
        <div style="flex:1">
          <div style="font-weight:700;margin-bottom:4px">${sanitizeInput(p.name)}</div>
          <div style="color:var(--text-muted);font-size:13px;margin-bottom:4px">${sanitizeInput(p.farm)}</div>
          <div style="color:var(--accent);font-weight:700">À partir de ${fmt(minPrice)}</div>
        </div>
        <button class="delete-btn" data-fav-id="${p.id}" style="background:var(--danger)">❤️</button>
      </div>
    `;
  }).join('');
  
  list.querySelectorAll('[data-product-id]').forEach(card => {
    card.onclick = (e) => {
      if (!e.target.closest('.delete-btn')) {
        openProduct(parseInt(card.dataset.productId));
      }
    };
  });
  
  list.querySelectorAll('[data-fav-id]').forEach(btn => {
    btn.onclick = async (e) => {
      e.stopPropagation();
      const confirmed = await confirmDelete('Retirer ce produit des favoris ?');
      if (confirmed) {
        FavoritesManager.toggle(parseInt(btn.dataset.favId));
        renderProducts(currentCategory, currentSort);
        renderFavorites();
      }
    };
  });
}

function renderOrders() {
  const list = document.getElementById('ordersList');
  const orders = OrdersManager.getAll();
  
  if (orders.length === 0) {
    list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px">Aucune commande pour le moment</div>';
    return;
  }
  
  list.innerHTML = orders.map(order => `
    <div class="order-card">
      <div class="order-header">
        <span class="order-number">#${order.id}</span>
        <span class="order-status ${order.status}">${order.status === 'delivered' ? 'Livrée' : 'En cours'}</span>
      </div>
      <div class="order-date">${new Date(order.date).toLocaleDateString('fr-FR', {day: 'numeric', month: 'long', year: 'numeric'})}</div>
      <div class="order-items">${order.itemCount} article${order.itemCount > 1 ? 's' : ''}</div>
      <div class="order-total">${fmt(order.total)}</div>
    </div>
  `).join('');
}

function renderReviews() {
  const allReviews = ReviewsManager.getAll();
  const reviewsList = document.getElementById('reviewsList');
  
  if (allReviews.length === 0) {
    reviewsList.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px">Aucun avis pour le moment</div>';
    return;
  }
  
  reviewsList.innerHTML = allReviews.map(r => {
    const date = new Date(r.date);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    let timeStr = '';
    if (diffDays === 0) timeStr = "Aujourd'hui";
    else if (diffDays === 1) timeStr = 'Hier';
    else if (diffDays < 7) timeStr = `Il y a ${diffDays} jours`;
    else if (diffDays < 30) timeStr = `Il y a ${Math.floor(diffDays / 7)} semaine${Math.floor(diffDays / 7) > 1 ? 's' : ''}`;
    else timeStr = `Il y a ${Math.floor(diffDays / 30)} mois`;
    
    return `
    <div class="info-card" style="flex-direction:column;align-items:flex-start">
      <div style="display:flex;justify-content:space-between;width:100%;margin-bottom:8px">
        <strong>${sanitizeInput(r.name || 'Anonyme')}</strong>
        <span>${'⭐'.repeat(r.stars)}</span>
      </div>
      <p style="color:var(--text-muted);font-size:12px;margin-bottom:8px">${timeStr}</p>
      <p style="font-size:15px">${sanitizeInput(r.text)}</p>
    </div>
  `}).join('');
}

function initEventListeners() {
  document.getElementById('themeToggle').onclick = toggleTheme;
  
  document.getElementById('menuBtn').onclick = () => {
    document.getElementById('sideMenu').classList.add('open');
    document.getElementById('menuOverlay').classList.add('open');
  };
  
  document.getElementById('menuClose').onclick = () => {
    document.getElementById('sideMenu').classList.remove('open');
    document.getElementById('menuOverlay').classList.remove('open');
  };
  
  document.getElementById('menuOverlay').onclick = () => {
    document.getElementById('sideMenu').classList.remove('open');
    document.getElementById('menuOverlay').classList.remove('open');
  };
  
  document.querySelectorAll('.menu-item').forEach(item => {
    item.onclick = () => {
      const page = item.dataset.page;
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + page).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      document.querySelector(`.nav-item[data-tab="${page}"]`)?.classList.add('active');
      document.getElementById('sideMenu').classList.remove('open');
      document.getElementById('menuOverlay').classList.remove('open');
      
      if (page === 'loyalty') {
        LoyaltyManager.renderDetails();
      }
    };
  });
  
  document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
    item.onclick = () => {
      const tab = item.dataset.tab;
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + tab).classList.add('active');
      
      if (tab === 'loyalty') {
        LoyaltyManager.renderDetails();
      }
    };
  });
  
  document.getElementById('cartBtn').onclick = openCart;
  document.getElementById('cartNavBtn').onclick = openCart;
  document.getElementById('closeCart').onclick = () => {
    document.getElementById('cartSheet').classList.add('hidden');
    document.body.classList.remove('modal-open');
  };
  
  document.getElementById('closeProduct').onclick = closeProduct;
  document.getElementById('validateOrder').onclick = validateOrder;
  
  document.getElementById('closeOrderSummary')?.addEventListener('click', () => {
    document.getElementById('orderSummarySheet').classList.add('hidden');
    document.body.classList.remove('modal-open');
  });
  
  document.getElementById('closeOrderSummaryBtn')?.addEventListener('click', () => {
    document.getElementById('orderSummarySheet').classList.add('hidden');
    document.body.classList.remove('modal-open');
    
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-home').classList.add('active');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelector('.nav-item[data-tab="home"]')?.classList.add('active');
  });
  
  document.querySelectorAll('.category-chip').forEach(chip => {
    chip.onclick = () => {
      document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      renderProducts(chip.dataset.cat, currentSort);
    };
  });
  
  document.querySelectorAll('.sort-chip').forEach(chip => {
    chip.onclick = () => {
      document.querySelectorAll('.sort-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      currentSort = chip.dataset.sort;
      renderProducts(currentCategory, currentSort);
    };
  });
  
  document.getElementById('searchInput').addEventListener('input', (e) => {
    searchProducts(e.target.value.toLowerCase());
  });
  
  document.getElementById('submitReview')?.addEventListener('click', () => {
    const name = document.getElementById('reviewName').value.trim();
    const stars = parseInt(document.getElementById('reviewStars').value);
    const text = document.getElementById('reviewText').value.trim();
    
    if (!text) {
      showToast('⚠️ Veuillez écrire votre avis');
      return;
    }
    
    if (text.length < 10) {
      showToast('⚠️ Votre avis doit contenir au moins 10 caractères');
      return;
    }
    
    const review = {
      name: name || 'Anonyme',
      stars: stars,
      text: text
    };
    
    ReviewsManager.add(review);
    
    document.getElementById('reviewName').value = '';
    document.getElementById('reviewStars').value = '5';
    document.getElementById('reviewText').value = '';
    
    renderReviews();
    showToast('✅ Merci pour votre avis !');
  });
  
  document.getElementById('loyaltyBanner').onclick = () => {
    const progress = LoyaltyManager.getCurrentProgress();
    const remaining = LoyaltyManager.getNextRewardIn();
    showToast(`🎁 ${progress}/10 commandes. Plus que ${remaining} pour une récompense !`);
  };
}

function init() {
  try {
    const testTheme = localStorage.getItem('theme');
    const testCart = localStorage.getItem('cart');
    
    if (testCart) {
      try {
        JSON.parse(testCart);
      } catch (e) {
        console.warn('⚠️ Données corrompues détectées, nettoyage...');
        localStorage.removeItem('cart');
      }
    }
  } catch (e) {
    console.error('❌ Erreur localStorage:', e);
  }
  
  try {
    CartManager.init();
    FavoritesManager.init();
    OrdersManager.init();
    LoyaltyManager.init();
    ReviewsManager.init();
    VideoObserver.init();
    initTheme();
    initEventListeners();
    renderProducts();
    renderFavorites();
    renderOrders();
    renderReviews();
    CartManager.updateUI();
    FavoritesManager.updateUI();
    
    console.log('✅ DROGUA CENTER v2.0 - Chargé avec succès');
    console.log('🔥 API Backend:', API_URL);
    console.log('💡 Pour réinitialiser : localStorage.clear() puis F5');
  } catch (error) {
    console.error('❌ Erreur initialisation:', error);
    showToast('⚠️ Erreur de chargement. Actualisez la page (F5)');
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
  </script>
</body>
</html>
