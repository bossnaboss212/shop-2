<span style="color:${profitColor}">${fmt(profit)}</span>
        </div>
      </div>
    `;
  }).join('');
}

function renderFinancialForecast() {
  const transactions = getTransactions();
  const now = new Date();
  
  const last7Days = transactions.filter(t => {
    const diff = now - new Date(t.date);
    return diff >= 0 && diff < 7 * 24 * 60 * 60 * 1000;
  });
  
  const last7Revenue = last7Days.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
  const last7Expense = last7Days.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
  const dailyAvg = (last7Revenue - last7Expense) / 7;
  
  const daysLeft = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate() - now.getDate();
  const projection = dailyAvg * daysLeft;
  
  const dailyProfits = {};
  transactions.forEach(t => {
    if (!dailyProfits[t.date]) dailyProfits[t.date] = 0;
    dailyProfits[t.date] += t.type === 'revenue' ? t.amount : -t.amount;
  });
  
  const bestDayEntry = Object.entries(dailyProfits).sort((a, b) => b[1] - a[1])[0];
  const bestDay = bestDayEntry ? bestDayEntry[1] : 0;
  const bestDayDate = bestDayEntry ? new Date(bestDayEntry[0]).toLocaleDateString('fr-FR') : '-';
  
  const monthTransactions = transactions.filter(t => {
    const d = new Date(t.date);
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  });
  const monthExpenses = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
  const monthRevenue = monthTransactions.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
  
  const alerts = [];
  if (monthExpenses > monthRevenue) alerts.push('‚ö†Ô∏è D√©penses > Revenus ce mois');
  if (dailyAvg < 0) alerts.push('üìâ Tendance n√©gative sur 7 jours');
  if (projection < 0) alerts.push('‚ö° Projection de perte ce mois');
  
  document.getElementById('projectionEndMonth').textContent = fmt(projection);
  document.getElementById('projectionEndMonth').style.color = projection >= 0 ? 'var(--success)' : 'var(--danger)';
  document.getElementById('bestDay').textContent = fmt(bestDay);
  document.getElementById('bestDayDate').textContent = bestDayDate;
  document.getElementById('financeAlerts').innerHTML = alerts.length > 0 
    ? alerts.map(a => `<div style="margin-bottom:4px">${a}</div>`).join('')
    : '<div style="color:var(--success)">‚úÖ Tout va bien</div>';
}

function updateCashBalanceDisplay() {
  const balance = parseFloat(localStorage.getItem('cash_balance') || '0');
  document.getElementById('cashBalance').textContent = fmt(balance);
  document.getElementById('currentCashBalance').value = balance.toFixed(2);
  
  const status = balance < 500 ? '‚ö†Ô∏è Faible' : balance > 2000 ? '‚úÖ Sain' : 'üí∞ Correct';
  document.getElementById('cashStatus').textContent = status;
}

function updateMonthlyGoalDisplay() {
  const goal = parseFloat(localStorage.getItem('monthly_goal') || '5000');
  const transactions = getTransactions();
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  
  const monthRevenue = transactions
    .filter(t => t.type === 'revenue' && new Date(t.date) >= monthStart)
    .reduce((sum, t) => sum + t.amount, 0);
  
  const progress = goal > 0 ? ((monthRevenue / goal) * 100).toFixed(1) : 0;
  
  document.getElementById('monthlyGoalProgress').textContent = progress + '%';
  document.getElementById('monthlyGoalProgress').style.color = progress >= 100 ? 'var(--success)' : 'var(--accent)';
  document.getElementById('monthlyGoalAmount').textContent = fmt(monthRevenue);
  document.getElementById('monthlyGoalTarget').textContent = fmt(goal);
  document.getElementById('monthlyGoalInput').value = goal;
}

document.getElementById('addTransaction')?.addEventListener('click', () => {
  const type = document.getElementById('transactionType').value;
  const category = document.getElementById('transactionCategory').value;
  const description = document.getElementById('transactionDescription').value.trim();
  const amount = parseFloat(document.getElementById('transactionAmount').value);
  const date = document.getElementById('transactionDate').value;
  const payment = document.getElementById('transactionPayment').value;
  const note = document.getElementById('transactionNote').value.trim();
  
  if (!description || !amount || amount <= 0 || !date) {
    showToast('Veuillez remplir tous les champs', 'error');
    return;
  }
  
  const transactions = getTransactions();
  transactions.unshift({
    type,
    category,
    description,
    amount,
    date,
    payment,
    note,
    created_at: new Date().toISOString()
  });
  
  saveTransactions(transactions);
  
  if (payment === 'especes') {
    const currentBalance = parseFloat(localStorage.getItem('cash_balance') || '0');
    const newBalance = type === 'revenue' ? currentBalance + amount : currentBalance - amount;
    localStorage.setItem('cash_balance', newBalance.toString());
  }
  
  document.getElementById('transactionDescription').value = '';
  document.getElementById('transactionAmount').value = '';
  document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('transactionNote').value = '';
  
  showToast('Transaction ajout√©e');
  loadFinances();
  loadStats();
});

document.getElementById('filterTransactionType')?.addEventListener('change', loadTransactionsTable);
document.getElementById('filterTransactionCategory')?.addEventListener('change', loadTransactionsTable);
document.getElementById('filterTransactionPeriod')?.addEventListener('change', loadTransactionsTable);
document.getElementById('filterTransactionPayment')?.addEventListener('change', loadTransactionsTable);
document.getElementById('searchTransaction')?.addEventListener('input', loadTransactionsTable);
document.getElementById('refreshFinances')?.addEventListener('click', loadFinances);
document.getElementById('chartPeriod')?.addEventListener('change', renderFinanceChart);

document.getElementById('updateCashBalance')?.addEventListener('click', () => {
  const newBalance = parseFloat(document.getElementById('newCashBalance').value);
  
  if (isNaN(newBalance) || newBalance < 0) {
    showToast('Montant invalide', 'error');
    return;
  }
  
  localStorage.setItem('cash_balance', newBalance.toString());
  document.getElementById('newCashBalance').value = '';
  
  showToast('Solde de caisse mis √† jour');
  updateCashBalanceDisplay();
  loadFinanceStats();
});

document.getElementById('setMonthlyGoal')?.addEventListener('click', () => {
  const goal = parseFloat(document.getElementById('monthlyGoalInput').value);
  
  if (isNaN(goal) || goal < 0) {
    showToast('Montant invalide', 'error');
    return;
  }
  
  localStorage.setItem('monthly_goal', goal.toString());
  
  showToast('Objectif mensuel d√©fini');
  updateMonthlyGoalDisplay();
});

document.getElementById('exportFinances')?.addEventListener('click', () => {
  const transactions = getTransactions();
  
  if (transactions.length === 0) {
    showToast('Aucune transaction √† exporter', 'error');
    return;
  }
  
  let csv = 'Date,Type,Cat√©gorie,Description,Paiement,Montant,Note\n';
  transactions.forEach(t => {
    const typeLabel = t.type === 'revenue' ? 'Revenu' : 'D√©pense';
    csv += `"${t.date}","${typeLabel}","${t.category}","${t.description}","${t.payment || ''}",${t.amount},"${t.note || ''}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `finances_${Date.now()}.csv`;
  a.click();
  
  showToast('Export r√©ussi');
});

document.getElementById('exportFinancesExcel')?.addEventListener('click', () => {
  const transactions = getTransactions();
  
  if (transactions.length === 0) {
    showToast('Aucune transaction √† exporter', 'error');
    return;
  }
  
  let html = '<table><thead><tr><th>Date</th><th>Type</th><th>Cat√©gorie</th><th>Description</th><th>Paiement</th><th>Montant</th><th>Note</th></tr></thead><tbody>';
  
  transactions.forEach(t => {
    const typeLabel = t.type === 'revenue' ? 'Revenu' : 'D√©pense';
    html += `<tr><td>${t.date}</td><td>${typeLabel}</td><td>${t.category}</td><td>${t.description}</td><td>${t.payment || ''}</td><td>${t.amount}</td><td>${t.note || ''}</td></tr>`;
  });
  
  html += '</tbody></table>';
  
  const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `finances_${Date.now()}.xls`;
  a.click();
  
  showToast('Export Excel r√©ussi');
});

// === PAYROLL ===

function getEmployees() {
  try {
    return JSON.parse(localStorage.getItem('employees') || '[]');
  } catch {
    return [];
  }
}

function saveEmployees(employees) {
  localStorage.setItem('employees', JSON.stringify(employees));
}

function getPayrollRecords() {
  try {
    return JSON.parse(localStorage.getItem('payroll_records') || '[]');
  } catch {
    return [];
  }
}

function savePayrollRecords(records) {
  localStorage.setItem('payroll_records', JSON.stringify(records));
}

async function loadPayroll() {
  showLoading('payrollLoading');
  try {
    loadPayrollStats();
    loadEmployeesTable();
    loadPayrollTable();
    populateEmployeeSelect();
    renderPayrollChart();
  } catch (e) {
    console.error('Error loading payroll:', e);
  } finally {
    hideLoading('payrollLoading');
  }
}

function loadPayrollStats() {
  const employees = getEmployees().filter(e => e.status === 'active');
  const records = getPayrollRecords();
  const now = new Date();
  
  const monthRecords = records.filter(r => {
    return r.month === (now.getMonth() + 1) && r.year === now.getFullYear();
  });
  
  const totalPayroll = monthRecords.reduce((sum, r) => sum + (r.grossAmount || 0), 0);
  const paidThisMonth = monthRecords.filter(r => r.status === 'paid').reduce((sum, r) => sum + (r.netAmount || 0), 0);
  const pendingPayments = monthRecords.filter(r => r.status === 'pending').length;
  
  document.getElementById('totalPayroll').textContent = fmt(totalPayroll);
  document.getElementById('activeEmployees').textContent = employees.length;
  document.getElementById('pendingPayments').textContent = pendingPayments;
  document.getElementById('paidThisMonth').textContent = fmt(paidThisMonth);
}

function loadEmployeesTable() {
  const employees = getEmployees();
  const tbody = document.getElementById('employeesTable');
  
  if (employees.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Aucun employ√©</td></tr>';
    return;
  }
  
  tbody.innerHTML = employees.map((e, idx) => {
    const statusBadge = e.status === 'active' 
      ? '<span class="badge success">Actif</span>'
      : '<span class="badge danger">Inactif</span>';
    
    const typeLabels = {
      mensuel: 'Mensuel',
      horaire: 'Horaire',
      journalier: 'Journalier'
    };
    
    const salaryLabel = e.type === 'mensuel' 
      ? `${fmt(e.salary)}/mois`
      : `${fmt(e.salary)}/${e.type === 'horaire' ? 'h' : 'jour'}`;
    
    return `
      <tr>
        <td><strong>${e.name}</strong></td>
        <td>${e.position}</td>
        <td><span class="badge">${typeLabels[e.type]}</span></td>
        <td>${salaryLabel}</td>
        <td>${new Date(e.hireDate).toLocaleDateString('fr-FR')}</td>
        <td>${statusBadge}</td>
        <td class="actions">
          ${e.status === 'active' 
            ? `<button class="btn-sm btn-warning" onclick="toggleEmployeeStatus(${idx})" title="D√©sactiver">‚ùå</button>`
            : `<button class="btn-sm btn-success" onclick="toggleEmployeeStatus(${idx})" title="Activer">‚úÖ</button>`
          }
          <button class="btn-sm btn-danger" onclick="deleteEmployee(${idx})" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  }).join('');
}

function loadPayrollTable() {
  let records = getPayrollRecords();
  
  const statusFilter = document.getElementById('filterPayrollStatus')?.value || 'all';
  const monthFilter = document.getElementById('filterPayrollMonth')?.value || 'all';
  const yearFilter = document.getElementById('filterPayrollYear')?.value || 'all';
  
  if (statusFilter !== 'all') {
    records = records.filter(r => r.status === statusFilter);
  }
  
  if (monthFilter !== 'all') {
    records = records.filter(r => r.month === parseInt(monthFilter));
  }
  
  if (yearFilter !== 'all') {
    records = records.filter(r => r.year === parseInt(yearFilter));
  }
  
  const tbody = document.getElementById('payrollTable');
  
  if (records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Aucune paie enregistr√©e</td></tr>';
    return;
  }
  
  records.sort((a, b) => {
    const dateA = new Date(a.year, a.month - 1);
    const dateB = new Date(b.year, b.month - 1);
    return dateB - dateA;
  });
  
  tbody.innerHTML = records.map((r, idx) => {
    const statusBadge = r.status === 'paid'
      ? '<span class="badge success">Pay√©</span>'
      : '<span class="badge warning">En attente</span>';
    
    const monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
    const period = `${monthNames[r.month - 1]} ${r.year}`;
    
    const paymentDate = r.paymentDate 
      ? new Date(r.paymentDate).toLocaleDateString('fr-FR')
      : '-';
    
    return `
      <tr>
        <td><strong>${r.employeeName}</strong><br><span class="muted" style="font-size:12px">${r.employeePosition}</span></td>
        <td>${period}</td>
        <td>${fmt(r.grossAmount)}</td>
        <td>${fmt(r.bonus || 0)}</td>
        <td><strong style="color:var(--success)">${fmt(r.netAmount)}</strong></td>
        <td>${statusBadge}</td>
        <td>${paymentDate}</td>
        <td class="actions">
          ${r.status === 'pending' 
            ? `<button class="btn-sm btn-success" onclick="markPayrollPaid(${idx})" title="Marquer comme pay√©">üíµ</button>`
            : ''
          }
          <button class="btn-sm btn-danger" onclick="deletePayroll(${idx})" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  }).join('');
}

function populateEmployeeSelect() {
  const employees = getEmployees().filter(e => e.status === 'active');
  const select = document.getElementById('payrollEmployee');
  
  select.innerHTML = '<option value="">S√©lectionner...</option>' +
    employees.map((e, idx) => `<option value="${idx}">${e.name} - ${e.position}</option>`).join('');
}

function renderPayrollChart() {
  const records = getPayrollRecords();
  const chartDiv = document.getElementById('payrollChart');
  
  if (records.length === 0) {
    chartDiv.innerHTML = '<div style="flex:1;text-align:center;color:var(--muted)">Aucune donn√©e</div>';
    return;
  }
  
  const monthlyData = {};
  const now = new Date();
  
  for (let i = 11; i >= 0; i--) {
    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = `${date.getFullYear()}-${date.getMonth() + 1}`;
    monthlyData[key] = 0;
  }
  
  records.filter(r => r.status === 'paid').forEach(r => {
    const key = `${r.year}-${r.month}`;
    if (monthlyData[key] !== undefined) {
      monthlyData[key] += r.netAmount || 0;
    }
  });
  
  const maxValue = Math.max(...Object.values(monthlyData), 1);
  
  chartDiv.innerHTML = Object.entries(monthlyData).map(([key, amount]) => {
    const [year, month] = key.split('-');
    const date = new Date(parseInt(year), parseInt(month) - 1);
    const label = date.toLocaleDateString('fr-FR', { month: 'short' });
    const height = (amount / maxValue) * 150;
    
    return `
      <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px;min-width:40px">
        <div style="display:flex;align-items:flex-end;height:150px">
          <div style="width:24px;background:var(--accent);height:${height}px;border-radius:4px 4px 0 0" title="${fmt(amount)}"></div>
        </div>
        <div style="font-size:11px;color:var(--muted)">${label}</div>
      </div>
    `;
  }).join('');
}

document.getElementById('addEmployee')?.addEventListener('click', () => {
  const name = document.getElementById('employeeName').value.trim();
  const position = document.getElementById('employeePosition').value.trim();
  const type = document.getElementById('employeeType').value;
  const salary = parseFloat(document.getElementById('employeeSalary').value);
  const hireDate = document.getElementById('employeeHireDate').value;
  
  if (!name || !position || !salary || salary <= 0 || !hireDate) {
    showToast('Veuillez remplir tous les champs', 'error');
    return;
  }
  
  const employees = getEmployees();
  employees.push({
    name,
    position,
    type,
    salary,
    hireDate,
    status: 'active',
    createdAt: new Date().toISOString()
  });
  
  saveEmployees(employees);
  
  document.getElementById('employeeName').value = '';
  document.getElementById('employeePosition').value = '';
  document.getElementById('employeeSalary').value = '';
  document.getElementById('employeeHireDate').value = '';
  
  showToast('Employ√© ajout√©');
  loadPayroll();
});

function toggleEmployeeStatus(index) {
  const employees = getEmployees();
  employees[index].status = employees[index].status === 'active' ? 'inactive' : 'active';
  saveEmployees(employees);
  
  showToast('Statut mis √† jour');
  loadPayroll();
}

function deleteEmployee(index) {
  if (!confirm('Supprimer cet employ√© ?')) return;
  
  const employees = getEmployees();
  employees.splice(index, 1);
  saveEmployees(employees);
  
  showToast('Employ√© supprim√©');
  loadPayroll();
}

document.getElementById('generatePayroll')?.addEventListener('click', () => {
  const employeeIdx = document.getElementById('payrollEmployee').value;
  const month = parseInt(document.getElementById('payrollMonth').value);
  const year = parseInt(document.getElementById('payrollYear').value);
  const hours = parseFloat(document.getElementById('payrollHours').value) || 0;
  const bonus = parseFloat(document.getElementById('payrollBonus').value) || 0;
  const note = document.getElementById('payrollNote').value.trim();
  
  if (employeeIdx === '') {
    showToast('Veuillez s√©lectionner un employ√©', 'error');
    return;
  }
  
  const employees = getEmployees();
  const employee = employees[parseInt(employeeIdx)];
  
  if (!employee) {
    showToast('Employ√© introuvable', 'error');
    return;
  }
  
  let grossAmount = 0;
  if (employee.type === 'mensuel') {
    grossAmount = employee.salary;
  } else if (employee.type === 'horaire') {
    if (hours === 0) {
      showToast('Veuillez indiquer le nombre d\'heures', 'error');
      return;
    }
    grossAmount = employee.salary * hours;
  } else if (employee.type === 'journalier') {
    if (hours === 0) {
      showToast('Veuillez indiquer le nombre de jours', 'error');
      return;
    }
    grossAmount = employee.salary * hours;
  }
  
  const charges = grossAmount * 0.22;
  const netAmount = grossAmount + bonus - charges;
  
  const records = getPayrollRecords();
  records.push({
    employeeName: employee.name,
    employeePosition: employee.position,
    month,
    year,
    type: employee.type,
    hours,
    grossAmount,
    bonus,
    charges,
    netAmount,
    note,
    status: 'pending',
    createdAt: new Date().toISOString()
  });
  
  savePayrollRecords(records);
  
  document.getElementById('payrollEmployee').value = '';
  document.getElementById('payrollHours').value = '0';
  document.getElementById('payrollBonus').value = '0';
  document.getElementById('payrollNote').value = '';
  
  showToast('Paie g√©n√©r√©e');
  loadPayroll();
});

function markPayrollPaid(index) {
  if (!confirm('Marquer cette paie comme pay√©e ?')) return;
  
  const records = getPayrollRecords();
  records[index].status = 'paid';
  records[index].paymentDate = new Date().toISOString();
  
  savePayrollRecords(records);
  
  const record = records[index];
  const transactions = getTransactions();
  transactions.unshift({
    type: 'expense',
    category: 'salaire',
    description: `Salaire ${record.employeeName} - ${record.month}/${record.year}`,
    amount: record.netAmount,
    date: new Date().toISOString().split('T')[0],
    payment: 'virement',
    note: record.note || '',
    created_at: new Date().toISOString()
  });
  saveTransactions(transactions);
  
  showToast('Paie marqu√©e comme pay√©e');
  loadPayroll();
  loadFinances();
}

function deletePayroll(index) {
  if (!confirm('Supprimer cette paie ?')) return;
  
  const records = getPayrollRecords();
  records.splice(index, 1);
  savePayrollRecords(records);
  
  showToast('Paie supprim√©e');
  loadPayroll();
}

document.getElementById('filterPayrollStatus')?.addEventListener('change', loadPayrollTable);
document.getElementById('filterPayrollMonth')?.addEventListener('change', loadPayrollTable);
document.getElementById('filterPayrollYear')?.addEventListener('change', loadPayrollTable);
document.getElementById('refreshPayroll')?.addEventListener('click', loadPayroll);

document.getElementById('exportPayroll')?.addEventListener('click', () => {
  const records = getPayrollRecords();
  
  if (records.length === 0) {
    showToast('Aucune paie √† exporter', 'error');
    return;
  }
  
  let csv = 'Employ√©,Poste,P√©riode,Type,Heures/Jours,Salaire brut,Primes,Charges,Net √† payer,Statut,Date paiement,Note\n';
  records.forEach(r => {
    const period = `${r.month}/${r.year}`;
    const paymentDate = r.paymentDate ? new Date(r.paymentDate).toLocaleDateString('fr-FR') : '-';
    csv += `"${r.employeeName}","${r.employeePosition}","${period}","${r.type}",${r.hours || 0},${r.grossAmount},${r.bonus || 0},${r.charges},${r.netAmount},"${r.status}","${paymentDate}","${r.note || ''}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `paie_${Date.now()}.csv`;
  a.click();
  
  showToast('Export r√©ussi');
});

// === STOCK ===
async function loadStockData() {
  populateProductSelect();
  await loadStock();
  await loadMovements();
  loadStats();
}

function populateProductSelect() {
  const select = document.getElementById('stockProduct');
  select.innerHTML = '<option value="">S√©lectionner...</option>' + 
    PRODUCTS_DATA.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  
  select.onchange = () => {
    const productId = parseInt(select.value);
    const product = PRODUCTS_DATA.find(p => p.id === productId);
    const variantSelect = document.getElementById('stockVariant');
    
    if (product) {
      variantSelect.innerHTML = '<option value="">S√©lectionner...</option>' +
        product.variants.map(v => `<option value="${v.label}">${v.label}</option>`).join('');
      variantSelect.disabled = false;
    } else {
      variantSelect.innerHTML = '<option value="">S√©lectionner...</option>';
      variantSelect.disabled = true;
    }
  };
}

async function loadStock() {
  showLoading('stockLoading');
  try {
    const data = await apiCall('/admin/stock');
    const tbody = document.getElementById('stockTable');
    
    if (!data.ok || data.stock.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Aucun stock</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.stock.map(s => {
      const product = PRODUCTS_DATA.find(p => p.id === s.product_id);
      const variant = product?.variants.find(v => v.label === s.variant);
      const value = variant ? s.qty * variant.price : 0;
      
      let statusBadge = '<span class="badge success">OK</span>';
      if (s.qty === 0) statusBadge = '<span class="badge danger">Rupture</span>';
      else if (s.qty < 10) statusBadge = '<span class="badge warning">Stock bas</span>';
      
      return `
        <tr>
          <td><strong>${product?.name || 'Inconnu'}</strong></td>
          <td>${s.variant}</td>
          <td><strong style="color:var(--accent)">${s.qty}</strong></td>
          <td>${statusBadge}</td>
          <td>${fmt(value)}</td>
          <td class="actions">
            <button class="btn-sm btn-primary" onclick="quickAddStock(${s.product_id}, '${s.variant}')">+ Rapide</button>
          </td>
        </tr>
      `;
    }).join('');
  } catch (e) {
    console.error('Error loading stock:', e);
  } finally {
    hideLoading('stockLoading');
  }
}

async function loadMovements() {
  try {
    const data = await apiCall('/admin/stock/movements');
    const tbody = document.getElementById('movementsTable');
    
    if (!data.ok || data.movements.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Aucun mouvement</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.movements.map(m => {
      const product = PRODUCTS_DATA.find(p => p.id === m.product_id);
      const typeBadge = m.type === 'in' 
        ? '<span class="badge success">‚ûï Entr√©e</span>' 
        : '<span class="badge danger">‚ûñ Sortie</span>';
      
      return `
        <tr>
          <td>${new Date(m.created_at).toLocaleString('fr-FR')}</td>
          <td><strong>${product?.name || 'Inconnu'}</strong></td>
          <td>${m.variant}</td>
          <td>${typeBadge}</td>
          <td><strong>${m.quantity}</strong></td>
          <td>${m.stock_after}</td>
          <td class="muted">${m.reason || '-'}</td>
        </tr>
      `;
    }).join('');
  } catch (e) {
    console.error('Error loading movements:', e);
  }
}

async function addStockMovement(productId, variant, type, quantity, reason = '') {
  try {
    await apiCall('/admin/stock/movement', {
      method: 'POST',
      body: JSON.stringify({ product_id: productId, variant, type, quantity, reason })
    });
    showToast('Stock mis √† jour');
    loadStockData();
  } catch (e) {
    showToast('Erreur de mise √† jour', 'error');
  }
}

document.getElementById('addStockMovement')?.addEventListener('click', () => {
  const productId = parseInt(document.getElementById('stockProduct').value);
  const variant = document.getElementById('stockVariant').value;
  const type = document.getElementById('stockType').value;
  const quantity = parseInt(document.getElementById('stockQty').value);
  const reason = document.getElementById('stockReason').value;
  
  if (!productId || !variant || !quantity) {
    showToast('Veuillez remplir tous les champs', 'error');
    return;
  }
  
  addStockMovement(productId, variant, type, quantity, reason);
  
  document.getElementById('stockProduct').value = '';
  document.getElementById('stockVariant').innerHTML = '<option value="">S√©lectionner...</option>';
  document.getElementById('stockVariant').disabled = true;
  document.getElementById('stockQty').value = '1';
  document.getElementById('stockReason').value = '';
});

function quickAddStock(productId, variant) {
  const qty = prompt('Quantit√© √† ajouter :', '10');
  if (qty && !isNaN(qty) && parseInt(qty) > 0) {
    addStockMovement(productId, variant, 'in', parseInt(qty), 'Ajout rapide');
  }
}

// === PRODUCTS ===
async function loadProducts() {
  showLoading('productsLoading');
  try {
    const tbody = document.getElementById('productsTable');
    tbody.innerHTML = PRODUCTS_DATA.map(p => `
      <tr>
        <td><strong>${p.name}</strong></td>
        <td><span class="badge">-</span></td>
        <td>${fmt(Math.min(...p.variants.map(v => v.price)))}</td>
        <td>${p.variants.length} variants</td>
        <td><span class="badge success">Actif</span></td>
        <td class="actions">
          <button class="btn-sm btn-primary" onclick="editProduct(${p.id})" title="√âditer">‚úèÔ∏è</button>
        </td>
      </tr>
    `).join('');
  } catch (e) {
    console.error('Error loading products:', e);
  } finally {
    hideLoading('productsLoading');
  }
}

function editProduct(id) {
  const product = PRODUCTS_DATA.find(p => p.id === id);
  if (!product) return;
  
  document.getElementById('editProductName').value = product.name;
  document.getElementById('editProductCategory').value = product.category || '';
  document.getElementById('editProductFarm').value = product.farm || '';
  document.getElementById('editProductActive').value = '1';
  document.getElementById('editProductVariants').value = JSON.stringify(product.variants, null, 2);
  
  document.getElementById('saveProductBtn').dataset.productId = id;
  document.getElementById('modalEditProduct').classList.add('active');
}

document.getElementById('saveProductBtn')?.addEventListener('click', () => {
  const idStr = document.getElementById('saveProductBtn').dataset.productId;
  
  if (idStr.startsWith('new_')) {
    const newId = parseInt(idStr.replace('new_', ''));
    
    try {
      const newProduct = {
        id: newId,
        name: document.getElementById('editProductName').value,
        category: document.getElementById('editProductCategory').value,
        farm: document.getElementById('editProductFarm').value,
        variants: JSON.parse(document.getElementById('editProductVariants').value)
      };
      
      PRODUCTS_DATA.push(newProduct);
      
      showToast('Produit cr√©√©');
      closeModal('modalEditProduct');
      loadProducts();
      populateProductSelect();
    } catch (e) {
      showToast('Erreur : V√©rifiez le format JSON des variants', 'error');
      console.error('Error creating product:', e);
    }
  } else {
    const id = parseInt(idStr);
    
    try {
      const product = PRODUCTS_DATA.find(p => p.id === id);
      if (!product) return;
      
      product.name = document.getElementById('editProductName').value;
      product.category = document.getElementById('editProductCategory').value;
      product.farm = document.getElementById('editProductFarm').value;
      
      const variantsText = document.getElementById('editProductVariants').value;
      product.variants = JSON.parse(variantsText);
      
      showToast('Produit mis √† jour');
      closeModal('modalEditProduct');
      loadProducts();
    } catch (e) {
      showToast('Erreur : V√©rifiez le format JSON des variants', 'error');
      console.error('Error saving product:', e);
    }
  }
});

document.getElementById('addProduct')?.addEventListener('click', () => {
  const newId = Math.max(...PRODUCTS_DATA.map(p => p.id)) + 1;
  
  document.getElementById('editProductName').value = '';
  document.getElementById('editProductCategory').value = '';
  document.getElementById('editProductFarm').value = '';
  document.getElementById('editProductActive').value = '1';
  document.getElementById('editProductVariants').value = '[\n  {"label":"5G","price":30},\n  {"label":"10G","price":60}\n]';
  
  document.getElementById('saveProductBtn').dataset.productId = 'new_' + newId;
  document.getElementById('modalEditProduct').classList.add('active');
});

document.getElementById('searchProducts')?.addEventListener('input', function() {
  const searchTerm = this.value.toLowerCase();
  const rows = document.querySelectorAll('#productsTable tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
});

// === REVIEWS ===
async function loadReviews() {
  showLoading('reviewsLoading');
  try {
    const data = await apiCall('/admin/reviews');
    const tbody = document.getElementById('reviewsTable');
    
    if (!data.ok || data.reviews.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Aucun avis</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.reviews.map(r => {
      const product = PRODUCTS_DATA.find(p => p.id === r.product_id);
      const statusBadge = r.approved 
        ? '<span class="badge success">Approuv√©</span>' 
        : '<span class="badge warning">En attente</span>';
      
      return `
        <tr>
          <td><strong>${product?.name || 'Produit'}</strong></td>
          <td>${r.name || 'Anonyme'}</td>
          <td>${'‚≠ê'.repeat(r.stars)}</td>
          <td>${r.text.substring(0, 50)}${r.text.length > 50 ? '...' : ''}</td>
          <td>${new Date(r.created_at).toLocaleDateString('fr-FR')}</td>
          <td>${statusBadge}</td>
          <td class="actions">
            ${!r.approved ? `<button class="btn-sm btn-success" onclick="approveReview('${r.id}')">‚úì</button>` : ''}
            <button class="btn-sm btn-danger" onclick="deleteReview('${r.id}')">üóëÔ∏è</button>
          </td>
        </tr>
      `;
    }).join('');
  } catch (e) {
    console.error('Error loading reviews:', e);
  } finally {
    hideLoading('reviewsLoading');
  }
}

async function approveReview(id) {
  try {
    await apiCall(`/admin/reviews/${id}`, {
      method: 'PUT',
      body: JSON.stringify({ approved: 1 })
    });
    showToast('Avis approuv√©');
    loadReviews();
  } catch (e) {
    showToast('Erreur', 'error');
  }
}

async function deleteReview(id) {
  if (!confirm('Supprimer cet avis ?')) return;
  try {
    await apiCall(`/admin/reviews/${id}`, { method: 'DELETE' });
    showToast('Avis supprim√©');
    loadReviews();
  } catch (e) {
    showToast('Erreur', 'error');
  }
}

document.getElementById('refreshReviews')?.addEventListener('click', loadReviews);

document.getElementById('filterReviews')?.addEventListener('change', function() {
  const filter = this.value;
  const rows = document.querySelectorAll('#reviewsTable tr');
  
  rows.forEach(row => {
    if (filter === 'all') {
      row.style.display = '';
    } else {
      const hasApproved = row.innerHTML.includes('Approuv√©');
      const hasPending = row.innerHTML.includes('En attente');
      
      if ((filter === 'approved' && hasApproved) || (filter === 'pending' && hasPending)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    }
  });
});

// === SETTINGS ===
async function loadSettings() {
  try {
    const data = await apiCall('/admin/settings');
    if (data.ok) {
      document.getElementById('settingShopName').value = data.settings.shop_name || 'DROGUA CENTER';
      document.getElementById('settingDeliveryFee').value = data.settings.delivery_fee || '20';
      document.getElementById('settingLoyalty').value = data.settings.loyalty_threshold || '10';
    }
  } catch (e) {
    console.error('Error loading settings:', e);
  }
}

document.getElementById('saveSettings')?.addEventListener('click', async () => {
  try {
    const settings = {
      shop_name: document.getElementById('settingShopName').value,
      delivery_fee: document.getElementById('settingDeliveryFee').value,
      loyalty_threshold: document.getElementById('settingLoyalty').value
    };
    
    await apiCall('/admin/settings', {
      method: 'PUT',
      body: JSON.stringify({ settings })
    });
    
    showToast('Param√®tres sauvegard√©s');
  } catch (e) {
    showToast('Erreur de sauvegarde', 'error');
  }
});

// === INITIALIZATION ===

function migrateOldData() {
  try {
    const ordersRaw = localStorage.getItem('admin_orders');
    if (ordersRaw) {
      const orders = JSON.parse(ordersRaw);
      const fixedOrders = orders.map(o => {
        if (typeof o.items === 'string') {
          try {
            o.items = JSON.parse(o.items);
          } catch {
            o.items = [];
          }
        } else if (!Array.isArray(o.items)) {
          o.items = [];
        }
        return o;
      });
      localStorage.setItem('admin_orders', JSON.stringify(fixedOrders));
    }
  } catch (e) {
    console.error('Migration error:', e);
  }
}

function initDemoData() {
  migrateOldData();
  
  if (!localStorage.getItem('admin_orders') || JSON.parse(localStorage.getItem('admin_orders')).length === 0) {
    const demoOrders = [
      {
        id: 1,
        customer: 'Client 1',
        type: 'Livraison sur Millau',
        address: '12 rue Example, Millau',
        items: [{"name":"AMNESIA","variant":"5G","qty":1,"price":30,"lineTotal":30}],
        total: 30,
        discount: 0,
        status: 'delivered',
        created_at: new Date(Date.now() - 86400000).toISOString()
      },
      {
        id: 2,
        customer: 'Client 2',
        type: 'Livraison ext√©rieure (+20‚Ç¨)',
        address: 'Paris',
        items: [{"name":"NEEDLES KETA","variant":"2G","qty":2,"price":40,"lineTotal":80}],
        total: 100,
        discount: 0,
        status: 'processing',
        created_at: new Date(Date.now() - 172800000).toISOString()
      },
      {
        id: 3,
        customer: 'Client 3',
        type: 'Livraison sur Millau',
        address: 'Millau Centre',
        items: [{"name":"EL JEFE","variant":"1G","qty":1,"price":50,"lineTotal":50}],
        total: 50,
        discount: 0,
        status: 'pending',
        created_at: new Date(Date.now() - 259200000).toISOString()
      }
    ];
    localStorage.setItem('admin_orders', JSON.stringify(demoOrders));
  }
  
  if (!localStorage.getItem('stock_data')) {
    const initialStock = {};
    PRODUCTS_DATA.forEach(product => {
      product.variants.forEach(variant => {
        const key = `${product.id}_${variant.label}`;
        initialStock[key] = Math.floor(Math.random() * 50) + 10;
      });
    });
    localStorage.setItem('stock_data', JSON.stringify(initialStock));
  }
  
  if (!localStorage.getItem('stock_movements')) {
    const demoMovements = [
      {product_id:1, variant:'5G', type:'in', quantity:50, stock_after:65, reason:'R√©approvisionnement', created_at:new Date(Date.now() - 86400000).toISOString()},
      {product_id:1, variant:'5G', type:'out', quantity:5, stock_after:15, reason:'Commande client', created_at:new Date(Date.now() - 172800000).toISOString()},
      {product_id:2, variant:'2G', type:'in', quantity:30, stock_after:45, reason:'Nouvel arrivage', created_at:new Date(Date.now() - 259200000).toISOString()}
    ];
    localStorage.setItem('stock_movements', JSON.stringify(demoMovements));
  }
  
  if (!localStorage.getItem('finance_transactions')) {
    const now = new Date();
    const demoTransactions = [
      {type: 'revenue', category: 'vente', description: 'Commande #1 - AMNESIA 5G', amount: 30, date: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], payment: 'especes', note: 'Client r√©gulier', created_at: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString()},
      {type: 'revenue', category: 'vente', description: 'Commande #2 - NEEDLES KETA 2G x2', amount: 100, date: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], payment: 'cb', note: 'Livraison express', created_at: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString()},
      {type: 'revenue', category: 'vente', description: 'Commande #3 - EL JEFE 1G', amount: 50, date: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], payment: 'crypto', note: '', created_at: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString()},
      {type: 'expense', category: 'achat_stock', description: 'R√©approvisionnement AMNESIA 100G', amount: 450, date: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], payment: 'virement', note: 'Fournisseur principal', created_at: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString()},
      {type: 'expense', category: 'livraison', description: 'Frais de livraison - Lot du 15/12', amount: 50, date: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], payment: 'especes', note: '', created_at: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString()},
      {type: 'expense', category: 'publicite', description: 'Publicit√© Telegram - D√©cembre', amount: 100, date: new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], payment: 'cb', note: 'Campagne mensuelle', created_at: new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000).toISOString()},
      {type: 'revenue', category: 'vente', description: 'Commande #4 - LEMON X GELATO 3.5G', amount: 40, date: new Date(now.getTime() - 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], payment: 'especes', note: '', created_at: new Date(now.getTime() - 4 * 24 * 60 * 60 * 1000).toISOString()},
      {type: 'expense', category: 'salaire', description: 'Salaire livreur - D√©cembre', amount: 300, date: new Date(now.getTime() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], payment: 'virement', note: 'Paiement mensuel', created_at: new Date(now.getTime() - 15 * 24 * 60 * 60 * 1000).toISOString()},
      {type: 'revenue', category: 'vente', description: 'Commande #5 - SKITTLEZ CAKE 5G', amount: 40, date: new Date(now.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], payment: 'cb', note: 'Nouveau client', created_at: new Date(now.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString()},
      {type: 'expense', category: 'loyer', description: 'Loyer local - D√©cembre', amount: 500, date: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], payment: 'virement', note: '', created_at: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000).toISOString()}
    ];
    localStorage.setItem('finance_transactions', JSON.stringify(demoTransactions));
  }
  
  if (!localStorage.getItem('cash_balance')) {
    localStorage.setItem('cash_balance', '1500');
  }
  
  if (!localStorage.getItem('monthly_goal')) {
    localStorage.setItem('monthly_goal', '5000');
  }
  
  if (!localStorage.getItem('employees')) {
    const demoEmployees = [
      {name: 'Jean Dupont', position: 'Livreur', type: 'mensuel', salary: 1800, hireDate: new Date(2024, 0, 15).toISOString().split('T')[0], status: 'active', createdAt: new Date(2024, 0, 15).toISOString()},
      {name: 'Marie Martin', position: 'Pr√©paratrice', type: 'horaire', salary: 15, hireDate: new Date(2024, 5, 1).toISOString().split('T')[0], status: 'active', createdAt: new Date(2024, 5, 1).toISOString()},
      {name: 'Paul Dubois', position: 'Assistant', type: 'mensuel', salary: 1500, hireDate: new Date(2024, 8, 10).toISOString().split('T')[0], status: 'active', createdAt: new Date(2024, 8, 10).toISOString()}
    ];
    localStorage.setItem('employees', JSON.stringify(demoEmployees));
  }
  
  if (!localStorage.getItem('payroll_records')) {
    const demoPayroll = [
      {employeeName: 'Jean Dupont', employeePosition: 'Livreur', month: 12, year: 2024, type: 'mensuel', hours: 0, grossAmount: 1800, bonus: 100, charges: 418, netAmount: 1482, note: 'Prime de No√´l', status: 'paid', paymentDate: new Date(2024, 11, 30).toISOString(), createdAt: new Date(2024, 11, 25).toISOString()},
      {employeeName: 'Marie Martin', employeePosition: 'Pr√©paratrice', month: 12, year: 2024, type: 'horaire', hours: 120, grossAmount: 1800, bonus: 0, charges: 396, netAmount: 1404, note: '120 heures travaill√©es', status: 'paid', paymentDate: new Date(2024, 11, 30).toISOString(), createdAt: new Date(2024, 11, 25).toISOString()},
      {employeeName: 'Paul Dubois', employeePosition: 'Assistant', month: 12, year: 2024, type: 'mensuel', hours: 0, grossAmount: 1500, bonus: 0, charges: 330, netAmount: 1170, note: '', status: 'pending', createdAt: new Date(2024, 11, 25).toISOString()}
    ];
    localStorage.setItem('payroll_records', JSON.stringify(demoPayroll));
  }
}

initDemoData();

const now = new Date();
document.getElementById('transactionDate').value = now.toISOString().split('T')[0];
document.getElementById('employeeHireDate').value = now.toISOString().split('T')[0];
document.getElementById('payrollMonth').value = now.getMonth() + 1;
document.getElementById('payrollYear').value = now.getFullYear();
</script>
</body>
</html>
        ? '<span class="badge success">  Object.entries(reviewsObj).forEach(([productId, revList]) => {
    revList.forEach((r, idx) => {
      reviews.push({
        id: `${productId}_${idx}`,
        product_id: parseInt(productId),
        name: r.name,
        stars: r.stars,
        text: r.text,
        approved: 1,
        created_at: new Date(r.date).toISOString()
      });
    });
  });
  
  return { ok: true, reviews };
}

function updateLocalReview(endpoint, options) {
  return { ok: true };
}

function deleteLocalReview(endpoint) {
  const id = endpoint.split('/').pop();
  const [productId, idx] = id.split('_');
  
  const reviews = JSON.parse(localStorage.getItem('product_reviews') || '{}');
  if (reviews[productId]) {
    reviews[productId].splice(parseInt(idx), 1);
    localStorage.setItem('product_reviews', JSON.stringify(reviews));
  }
  
  return { ok: true };
}

function getLocalSettings() {
  return {
    ok: true,
    settings: {
      shop_name: 'DROGUA CENTER',
      delivery_fee: '20',
      loyalty_threshold: '10'
    }
  };
}

function saveLocalSettings(options) {
  return { ok: true };
}

// === LOGIN ===
document.getElementById('login').onclick = async () => {
  const pass = document.getElementById('pass').value;
  
  if (pass !== ADMIN_PASS) {
    showToast('Mot de passe incorrect', 'error');
    return;
  }
  
  if (USE_LOCAL_MODE) {
    TOKEN = 'local-admin-token';
    document.getElementById('auth').style.display = 'none';
    document.getElementById('dash').style.display = 'block';
    document.getElementById('modeIndicator').style.display = 'inline-block';
    showToast('Connect√© en mode local (donn√©es localStorage)', 'success');
    loadDashboard();
    return;
  }
  
  try {
    const response = await fetch(API + '/admin/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pass })
    });
    
    const data = await response.json();
    
    if (data.ok && data.token) {
      TOKEN = data.token;
      document.getElementById('auth').style.display = 'none';
      document.getElementById('dash').style.display = 'block';
      showToast('Connect√© en mode API', 'success');
      loadDashboard();
    } else {
      showToast('Erreur de connexion', 'error');
    }
  } catch (e) {
    showToast('Erreur serveur - Mode local activ√©', 'error');
    console.error('Login error:', e);
  }
};

function logout() {
  TOKEN = null;
  document.getElementById('dash').style.display = 'none';
  document.getElementById('auth').style.display = 'block';
  document.getElementById('pass').value = '';
}

document.getElementById('logoutBtn')?.addEventListener('click', logout);

// === TABS ===
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    
    const tab = btn.dataset.tab;
    if (tab === 'orders') loadOrders();
    else if (tab === 'finances') loadFinances();
    else if (tab === 'payroll') loadPayroll();
    else if (tab === 'stock') loadStockData();
    else if (tab === 'products') loadProducts();
    else if (tab === 'reviews') loadReviews();
    else if (tab === 'settings') loadSettings();
  };
});

// === DASHBOARD ===
async function loadDashboard() {
  loadStats();
  loadOrders();
  loadStockData();
}

async function loadStats() {
  try {
    const data = await apiCall('/admin/stats');
    if (data.ok) {
      const s = data.stats;
      document.getElementById('totalCA').textContent = fmt(s.totalCA);
      document.getElementById('totalOrders').textContent = s.totalOrders;
      document.getElementById('avgOrder').textContent = fmt(s.avgOrder);
      document.getElementById('topProduct').textContent = s.topProduct;
      document.getElementById('stockValue').textContent = fmt(s.stockValue);
      document.getElementById('stockAlerts').textContent = s.stockOut + s.stockLow;
    }
  } catch (e) {
    console.error('Error loading stats:', e);
  }
}

// === ORDERS ===
async function loadOrders() {
  showLoading('ordersLoading');
  try {
    const status = document.getElementById('filterStatus').value;
    const data = await apiCall(`/admin/orders?status=${status}`);
    
    const tbody = document.getElementById('ordersTable');
    if (!data.ok || data.orders.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Aucune commande</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.orders.map(o => {
      const statusBadge = {
        pending: '<span class="badge warning">En attente</span>',
        processing: '<span class="badge info">En traitement</span>',
        delivered: '<span class="badge success">Livr√©</span>',
        cancelled: '<span class="badge danger">Annul√©</span>'
      }[o.status] || '<span class="badge">Inconnu</span>';
      
      return `
        <tr>
          <td><strong>#${o.id}</strong></td>
          <td>${new Date(o.created_at).toLocaleDateString('fr-FR')}</td>
          <td>${o.customer}</td>
          <td><span class="badge">${o.type}</span></td>
          <td>${o.items.length} article(s)</td>
          <td><strong style="color:var(--accent)">${fmt(o.total)}</strong></td>
          <td>${statusBadge}</td>
          <td class="actions">
            <button class="btn-sm btn-primary" onclick="viewOrder(${o.id})" title="Voir les d√©tails">üëÅÔ∏è</button>
            <button class="btn-sm btn-primary" onclick="editOrder(${o.id})" title="√âditer">‚úèÔ∏è</button>
            <button class="btn-sm btn-danger" onclick="deleteOrder(${o.id})" title="Supprimer">üóëÔ∏è</button>
          </td>
        </tr>
      `;
    }).join('');
  } catch (e) {
    console.error('Error loading orders:', e);
    showToast('Erreur de chargement', 'error');
  } finally {
    hideLoading('ordersLoading');
  }
}

async function viewOrder(id) {
  try {
    const data = await apiCall(`/admin/orders?limit=1000`);
    const order = data.orders.find(o => o.id === id);
    if (!order) return;
    
    const details = document.getElementById('orderDetails');
    details.innerHTML = `
      <div style="margin-bottom:16px">
        <strong>Commande #${order.id}</strong><br>
        <span class="muted">Date: ${new Date(order.created_at).toLocaleString('fr-FR')}</span>
      </div>
      <div style="margin-bottom:16px">
        <strong>Client:</strong> ${order.customer}<br>
        <strong>Type:</strong> ${order.type}<br>
        <strong>Adresse:</strong> ${order.address || '-'}
      </div>
      <div style="margin-bottom:16px">
        <strong>Articles:</strong>
        <ul style="list-style:none;padding:0;margin-top:8px">
          ${order.items.map(it => `<li style="padding:6px;background:var(--bg);border-radius:6px;margin-bottom:4px">
            ${it.name} - ${it.variant} - ${it.qty} √ó ${fmt(it.price)} = <strong>${fmt(it.lineTotal)}</strong>
          </li>`).join('')}
        </ul>
      </div>
      <div style="padding-top:12px;border-top:1px solid var(--border)">
        <strong>Remise fid√©lit√©:</strong> ${fmt(order.discount || 0)}<br>
        <strong style="font-size:18px;color:var(--accent)">Total: ${fmt(order.total)}</strong>
      </div>
    `;
    document.getElementById('modalOrder').classList.add('active');
  } catch (e) {
    console.error('Error viewing order:', e);
  }
}

async function editOrder(id) {
  try {
    const data = await apiCall(`/admin/orders?limit=1000`);
    const order = data.orders.find(o => o.id === id);
    if (!order) return;
    
    document.getElementById('editOrderCustomer').value = order.customer;
    document.getElementById('editOrderType').value = order.type;
    document.getElementById('editOrderAddress').value = order.address || '';
    document.getElementById('editOrderStatus').value = order.status || 'pending';
    document.getElementById('editOrderTotal').value = order.total;
    
    document.getElementById('saveOrderBtn').dataset.orderId = id;
    
    document.getElementById('modalEditOrder').classList.add('active');
  } catch (e) {
    console.error('Error editing order:', e);
    showToast('Erreur de chargement', 'error');
  }
}

document.getElementById('saveOrderBtn')?.addEventListener('click', async () => {
  const id = document.getElementById('saveOrderBtn').dataset.orderId;
  if (!id) return;
  
  try {
    const updates = {
      customer: document.getElementById('editOrderCustomer').value,
      type: document.getElementById('editOrderType').value,
      address: document.getElementById('editOrderAddress').value,
      status: document.getElementById('editOrderStatus').value,
      total: parseFloat(document.getElementById('editOrderTotal').value)
    };
    
    await apiCall(`/admin/orders/${id}`, {
      method: 'PUT',
      body: JSON.stringify(updates)
    });
    
    showToast('Commande mise √† jour');
    closeModal('modalEditOrder');
    loadOrders();
  } catch (e) {
    showToast('Erreur de sauvegarde', 'error');
  }
});

async function deleteOrder(id) {
  if (!confirm('Supprimer cette commande ?')) return;
  try {
    await apiCall(`/admin/orders/${id}`, { method: 'DELETE' });
    showToast('Commande supprim√©e');
    loadOrders();
    loadStats();
  } catch (e) {
    showToast('Erreur de suppression', 'error');
  }
}

document.getElementById('refreshOrders')?.addEventListener('click', loadOrders);
document.getElementById('filterStatus')?.addEventListener('change', loadOrders);

document.getElementById('searchOrders')?.addEventListener('input', function() {
  const searchTerm = this.value.toLowerCase();
  const rows = document.querySelectorAll('#ordersTable tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
});

document.getElementById('exportOrders')?.addEventListener('click', async () => {
  try {
    const orders = JSON.parse(localStorage.getItem('admin_orders') || '[]');
    let csv = 'ID,Date,Client,Type,Adresse,Total,Remise,Statut\n';
    orders.forEach(o => {
      const date = new Date(o.created_at || Date.now()).toLocaleString('fr-FR');
      csv += `${o.id},"${date}","${o.customer}","${o.type}","${o.address || ''}",${o.total},${o.discount || 0},"${o.status || 'pending'}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `orders_${Date.now()}.csv`;
    a.click();
    showToast('Export r√©ussi');
  } catch (e) {
    showToast('Erreur d\'export', 'error');
  }
});

// === FINANCES ===

function getTransactions() {
  try {
    return JSON.parse(localStorage.getItem('finance_transactions') || '[]');
  } catch {
    return [];
  }
}

function saveTransactions(transactions) {
  localStorage.setItem('finance_transactions', JSON.stringify(transactions));
}

async function loadFinances() {
  showLoading('financesLoading');
  try {
    loadFinanceStats();
    loadTransactionsTable();
    renderFinanceChart();
    renderCategoryReport();
    renderTopExpenses();
    renderMonthlyPerformance();
    renderFinancialForecast();
    updateCashBalanceDisplay();
    updateMonthlyGoalDisplay();
  } catch (e) {
    console.error('Error loading finances:', e);
  } finally {
    hideLoading('financesLoading');
  }
}

function loadFinanceStats() {
  const transactions = getTransactions();
  
  const revenues = transactions.filter(t => t.type === 'revenue');
  const expenses = transactions.filter(t => t.type === 'expense');
  
  const totalRevenue = revenues.reduce((sum, t) => sum + t.amount, 0);
  const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);
  const netProfit = totalRevenue - totalExpenses;
  const profitMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0;
  
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthTransactions = transactions.filter(t => new Date(t.date) >= monthStart);
  const monthRevenue = monthTransactions.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
  const monthExpenses = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
  const monthBalance = monthRevenue - monthExpenses;
  
  const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
  const lastMonthTransactions = transactions.filter(t => {
    const d = new Date(t.date);
    return d >= lastMonthStart && d <= lastMonthEnd;
  });
  const lastMonthRevenue = lastMonthTransactions.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
  const revenueGrowth = lastMonthRevenue > 0 ? (((monthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100).toFixed(1) : 0;
  
  const daysInMonth = now.getDate();
  const dailyAverage = daysInMonth > 0 ? monthBalance / daysInMonth : 0;
  
  document.getElementById('totalRevenue').textContent = fmt(totalRevenue);
  document.getElementById('totalExpenses').textContent = fmt(totalExpenses);
  document.getElementById('netProfit').textContent = fmt(netProfit);
  document.getElementById('netProfit').style.color = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';
  document.getElementById('profitMargin').textContent = profitMargin + '%';
  document.getElementById('revenueGrowth').textContent = revenueGrowth + '%';
  document.getElementById('revenueGrowth').style.color = parseFloat(revenueGrowth) >= 0 ? 'var(--success)' : 'var(--danger)';
  document.getElementById('dailyAverage').textContent = fmt(dailyAverage);
}

function loadTransactionsTable() {
  let transactions = getTransactions();
  
  const typeFilter = document.getElementById('filterTransactionType')?.value || 'all';
  const categoryFilter = document.getElementById('filterTransactionCategory')?.value || 'all';
  const periodFilter = document.getElementById('filterTransactionPeriod')?.value || 'all';
  const paymentFilter = document.getElementById('filterTransactionPayment')?.value || 'all';
  const searchTerm = document.getElementById('searchTransaction')?.value?.toLowerCase() || '';
  
  if (typeFilter !== 'all') {
    transactions = transactions.filter(t => t.type === typeFilter);
  }
  
  if (categoryFilter !== 'all') {
    transactions = transactions.filter(t => t.category === categoryFilter);
  }
  
  if (paymentFilter !== 'all') {
    transactions = transactions.filter(t => t.payment === paymentFilter);
  }
  
  if (searchTerm) {
    transactions = transactions.filter(t => 
      t.description.toLowerCase().includes(searchTerm) ||
      (t.note && t.note.toLowerCase().includes(searchTerm))
    );
  }
  
  if (periodFilter !== 'all') {
    const now = new Date();
    let startDate;
    
    if (periodFilter === 'today') {
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    } else if (periodFilter === 'week') {
      startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    } else if (periodFilter === 'month') {
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
    } else if (periodFilter === 'lastmonth') {
      startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const endDate = new Date(now.getFullYear(), now.getMonth(), 0);
      transactions = transactions.filter(t => {
        const d = new Date(t.date);
        return d >= startDate && d <= endDate;
      });
    } else if (periodFilter === 'year') {
      startDate = new Date(now.getFullYear(), 0, 1);
    }
    
    if (startDate && periodFilter !== 'lastmonth') {
      transactions = transactions.filter(t => new Date(t.date) >= startDate);
    }
  }
  
  const tbody = document.getElementById('transactionsTable');
  
  if (transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Aucune transaction</td></tr>';
    return;
  }
  
  transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  tbody.innerHTML = transactions.map((t, idx) => {
    const typeBadge = t.type === 'revenue' 
      ? '<span class="badge success">üí∞ Revenu</span>'
      : '<span class="badge danger">üí∏ D√©pense</span>';
    
    const categoryLabels = {
      vente: 'Vente',
      achat_stock: 'Achat stock',
      livraison: 'Livraison',
      salaire: 'Salaire',
      loyer: 'Loyer',
      publicite: 'Publicit√©',
      commission: 'Commission',
      maintenance: 'Maintenance',
      assurance: 'Assurance',
      autre: 'Autre'
    };
    
    const paymentLabels = {
      especes: 'üíµ Esp√®ces',
      cb: 'üí≥ CB',
      virement: 'üè¶ Virement',
      crypto: '‚Çø Crypto',
      autre: 'Autre'
    };
    
    const amountColor = t.type === 'revenue' ? 'var(--success)' : 'var(--danger)';
    const amountSign = t.type === 'revenue' ? '+' : '-';
    
    return `
      <tr>
        <td>${new Date(t.date).toLocaleDateString('fr-FR')}</td>
        <td>${typeBadge}</td>
        <td><span class="badge">${categoryLabels[t.category] || t.category}</span></td>
        <td>${t.description}</td>
        <td><span class="badge info">${paymentLabels[t.payment] || t.payment}</span></td>
        <td><strong style="color:${amountColor}">${amountSign}${fmt(t.amount)}</strong></td>
        <td class="muted" style="font-size:12px">${t.note || '-'}</td>
        <td class="actions">
          <button class="btn-sm btn-danger" onclick="deleteTransaction(${idx})" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  }).join('');
}

function deleteTransaction(index) {
  if (!confirm('Supprimer cette transaction ?')) return;
  
  const transactions = getTransactions();
  transactions.splice(index, 1);
  saveTransactions(transactions);
  
  showToast('Transaction supprim√©e');
  loadFinances();
}

function renderFinanceChart() {
  const transactions = getTransactions();
  const chartDiv = document.getElementById('financeChart');
  const period = parseInt(document.getElementById('chartPeriod')?.value || '30');
  
  const now = new Date();
  const dailyRevenue = {};
  const dailyExpense = {};
  
  for (let i = 0; i < period; i++) {
    const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
    const dateKey = date.toISOString().split('T')[0];
    dailyRevenue[dateKey] = 0;
    dailyExpense[dateKey] = 0;
  }
  
  transactions.forEach(t => {
    const dateKey = t.date;
    if (dateKey in dailyRevenue) {
      if (t.type === 'revenue') {
        dailyRevenue[dateKey] += t.amount;
      } else {
        dailyExpense[dateKey] += t.amount;
      }
    }
  });
  
  const maxValue = Math.max(
    ...Object.values(dailyRevenue),
    ...Object.values(dailyExpense),
    1
  );
  
  const dates = Object.keys(dailyRevenue).sort().slice(-14);
  
  chartDiv.innerHTML = dates.map(date => {
    const revenue = dailyRevenue[date];
    const expense = dailyExpense[date];
    const profit = revenue - expense;
    const revenueHeight = (revenue / maxValue) * 180;
    const expenseHeight = (expense / maxValue) * 180;
    const profitHeight = Math.abs((profit / maxValue) * 180);
    const dayLabel = new Date(date).toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' });
    
    return `
      <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px;min-width:50px">
        <div style="display:flex;gap:3px;align-items:flex-end;height:180px">
          <div style="width:14px;background:var(--success);height:${revenueHeight}px;border-radius:4px 4px 0 0" title="Revenus: ${fmt(revenue)}"></div>
          <div style="width:14px;background:var(--danger);height:${expenseHeight}px;border-radius:4px 4px 0 0" title="D√©penses: ${fmt(expense)}"></div>
          <div style="width:14px;background:${profit >= 0 ? 'var(--accent)' : 'var(--warning)'};height:${profitHeight}px;border-radius:4px 4px 0 0" title="B√©n√©fice: ${fmt(profit)}"></div>
        </div>
        <div style="font-size:10px;color:var(--muted);text-align:center;white-space:nowrap">${dayLabel}</div>
      </div>
    `;
  }).join('');
}

function renderTopExpenses() {
  const transactions = getTransactions();
  const expenses = transactions.filter(t => t.type === 'expense');
  
  const topExpenses = [...expenses]
    .sort((a, b) => b.amount - a.amount)
    .slice(0, 5);
  
  const div = document.getElementById('topExpenses');
  
  if (topExpenses.length === 0) {
    div.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">Aucune d√©pense</div>';
    return;
  }
  
  div.innerHTML = topExpenses.map((t, idx) => `
    <div style="display:flex;justify-content:space-between;padding:10px;background:var(--bg);border-radius:6px;margin-bottom:8px">
      <div>
        <div style="font-weight:600">${idx + 1}. ${t.description}</div>
        <div style="font-size:12px;color:var(--muted)">${new Date(t.date).toLocaleDateString('fr-FR')}</div>
      </div>
      <div style="color:var(--danger);font-weight:700">${fmt(t.amount)}</div>
    </div>
  `).join('');
}

function renderCategoryReport() {
  const transactions = getTransactions();
  const expenses = transactions.filter(t => t.type === 'expense');
  
  const categoryTotals = {};
  expenses.forEach(t => {
    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
  });
  
  const reportDiv = document.getElementById('categoryReport');
  
  if (Object.keys(categoryTotals).length === 0) {
    reportDiv.innerHTML = '<div style="color:var(--muted);text-align:center">Aucune d√©pense enregistr√©e</div>';
    return;
  }
  
  const total = Object.values(categoryTotals).reduce((sum, v) => sum + v, 0);
  const categoryLabels = {
    achat_stock: 'Achat stock',
    livraison: 'Livraison',
    salaire: 'Salaire',
    loyer: 'Loyer',
    publicite: 'Publicit√©',
    commission: 'Commission',
    maintenance: 'Maintenance',
    assurance: 'Assurance',
    autre: 'Autre'
  };
  
  reportDiv.innerHTML = Object.entries(categoryTotals)
    .sort((a, b) => b[1] - a[1])
    .map(([cat, amount]) => {
      const percentage = (amount / total * 100).toFixed(1);
      return `
        <div style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px">
            <span><strong>${categoryLabels[cat] || cat}</strong></span>
            <span style="color:var(--accent)">${fmt(amount)} (${percentage}%)</span>
          </div>
          <div style="background:var(--border);height:8px;border-radius:4px;overflow:hidden">
            <div style="background:var(--accent);height:100%;width:${percentage}%;border-radius:4px"></div>
          </div>
        </div>
      `;
    }).join('');
}

function renderMonthlyPerformance() {
  const transactions = getTransactions();
  const div = document.getElementById('monthlyPerformance');
  
  const monthlyData = {};
  const now = new Date();
  
  for (let i = 5; i >= 0; i--) {
    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    const monthName = date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
    monthlyData[key] = { name: monthName, revenue: 0, expense: 0 };
  }
  
  transactions.forEach(t => {
    const date = new Date(t.date);
    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    if (monthlyData[key]) {
      if (t.type === 'revenue') {
        monthlyData[key].revenue += t.amount;
      } else {
        monthlyData[key].expense += t.amount;
      }
    }
  });
  
  div.innerHTML = Object.values(monthlyData).map(m => {
    const profit = m.revenue - m.expense;
    const profitColor = profit >= 0 ? 'var(--success)' : 'var(--danger)';
    
    return `
      <div style="padding:12px;background:var(--bg);border-radius:6px;margin-bottom:8px">
        <div style="font-weight:600;margin-bottom:8px">${m.name}</div>
        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px">
          <span style="color:var(--muted)">Revenus</span>
          <span style="color:var(--success)">${fmt(m.revenue)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px">
          <span style="color:var(--muted)">D√©penses</span>
          <span style="color:var(--danger)">${fmt(m.expense)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:14px;font-weight:700;padding-top:8px;border-top:1px solid var(--border)">
          <span>B√©n√©fice</span>
          <span style="color:${profitColor}">${fmt(profit<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin - DROGUA CENTER</title>
  <style>
:root{--bg:#0d1419;--card:#1e2936;--text:#e8edf2;--muted:#7a8594;--accent:#5ba3f5;--border:#2a3441;--success:#10b981;--danger:#ef4444;--warning:#f59e0b}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);padding:20px}

.container{max-width:1400px;margin:0 auto}
h1{margin-bottom:30px;text-align:center;display:flex;align-items:center;justify-content:center;gap:12px}

/* Login */
#auth{max-width:400px;margin:100px auto;background:var(--card);padding:30px;border-radius:16px;border:1px solid var(--border)}
#auth h2{margin-bottom:20px;text-align:center}
input,button,select,textarea{padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);width:100%;font-size:14px;margin-bottom:10px;font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
button{background:var(--accent);color:#fff;border:none;cursor:pointer;font-weight:600;transition:all 0.2s}
button:hover{background:#6baff7;transform:translateY(-1px)}
button:disabled{opacity:0.5;cursor:not-allowed;transform:none}

/* Dashboard */
#dash{display:none}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
.stat-card{background:var(--card);padding:20px;border-radius:12px;border:1px solid var(--border);transition:all 0.2s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.stat-card h3{font-size:14px;color:var(--muted);margin-bottom:8px}
.stat-card .value{font-size:32px;font-weight:700;color:var(--accent)}
.stat-card .trend{font-size:13px;margin-top:8px;display:flex;align-items:center;gap:4px}
.trend.up{color:var(--success)}
.trend.down{color:var(--danger)}

/* Tabs */
.tabs{display:flex;gap:10px;margin-bottom:20px;border-bottom:1px solid var(--border);overflow-x:auto}
.tab-btn{background:transparent;border:none;color:var(--muted);padding:12px 20px;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;white-space:nowrap}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-btn:hover{color:var(--text)}

.tab-content{display:none}
.tab-content.active{display:block}

/* Toolbar */
.toolbar{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.toolbar input,.toolbar select{width:auto;flex:1;min-width:200px}
.toolbar button{width:auto;margin:0}

/* Table */
.table-container{background:var(--card);border-radius:12px;overflow:hidden;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
th{background:#0d1419;font-weight:600;color:var(--muted);font-size:13px;text-transform:uppercase}
tr:hover{background:#252d38}
tbody tr:last-child td{border-bottom:none}

.badge{background:#2a3441;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;display:inline-block}
.badge.success{background:rgba(16,185,129,0.2);color:#10b981}
.badge.warning{background:rgba(245,158,11,0.2);color:#f59e0b}
.badge.danger{background:rgba(239,68,68,0.2);color:#ef4444}
.badge.info{background:rgba(91,163,245,0.2);color:#5ba3f5}

/* Actions */
.actions{display:flex;gap:8px}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:6px;border:none;cursor:pointer;transition:all 0.2s;margin:0}
.btn-primary{background:var(--accent);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-warning{background:var(--warning);color:#fff}
.btn-sm:hover{transform:translateY(-1px);opacity:0.9}

.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:none;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-header h3{font-size:20px}
.modal-close{background:transparent;border:none;color:var(--text);font-size:28px;cursor:pointer;padding:0;width:auto}
.modal-body{margin-bottom:20px}
.modal-footer{display:flex;gap:10px;justify-content:flex-end}

.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600}
.form-group input,.form-group select,.form-group textarea{margin:0}

/* Chart */
.chart-container{background:var(--card);padding:20px;border-radius:12px;border:1px solid var(--border);margin-bottom:20px;transition:all 0.2s}
.chart-container:hover{box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.chart-container h3{margin-bottom:16px;font-size:16px;display:flex;align-items:center;gap:8px}
.chart-container h3[onclick]{cursor:pointer;user-select:none}
.chart-container h3[onclick]:hover{color:var(--accent)}

/* Loading */
.loading{display:none;justify-content:center;align-items:center;padding:40px}
.loading.active{display:flex}
.spinner{border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Toast */
.toast{position:fixed;top:20px;right:20px;background:var(--card);border:1px solid var(--border);border-left:4px solid var(--success);padding:16px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:2000;opacity:0;transform:translateX(400px);transition:all 0.3s}
.toast.show{opacity:1;transform:translateX(0)}
.toast.error{border-left-color:var(--danger)}

/* Stock form */
.stock-form{background:var(--card);padding:20px;border-radius:12px;border:1px solid var(--border);margin-bottom:20px}
.stock-form h3{margin-bottom:16px;font-size:16px}
.stock-grid{display:grid;grid-template-columns:2fr 2fr 1fr 1fr 2fr auto;gap:10px;align-items:end}
.stock-grid > div label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
.stock-grid input,.stock-grid select{margin:0}

.muted{color:var(--muted)}
.small{font-size:12px}

@media (max-width:768px){
  .stats{grid-template-columns:1fr}
  .toolbar{flex-direction:column}
  .toolbar input,.toolbar select{width:100%}
  .stock-grid{grid-template-columns:1fr;gap:12px}
  .actions{flex-wrap:wrap}
}
  </style>
</head>
<body>
<div class="container">
  <!-- Login -->
  <div id="auth">
    <h2>üîê Admin Panel</h2>
    <input id="pass" type="password" placeholder="Mot de passe" autocomplete="current-password">
    <button id="login">Se connecter</button>
  </div>

  <!-- Dashboard -->
  <div id="dash">
    <h1>
      <span>üìä</span>
      <span>Dashboard Admin</span>
      <span id="modeIndicator" style="font-size:12px;background:var(--warning);color:#000;padding:4px 10px;border-radius:6px;margin-left:12px;display:none">MODE LOCAL</span>
    </h1>
    
    <!-- Stats -->
    <div class="stats">
      <div class="stat-card">
        <h3>Chiffre d'affaires total</h3>
        <div class="value" id="totalCA">0,00 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <h3>Nombre de commandes</h3>
        <div class="value" id="totalOrders">0</div>
      </div>
      <div class="stat-card">
        <h3>Panier moyen</h3>
        <div class="value" id="avgOrder">0,00 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <h3>Produit le plus vendu</h3>
        <div class="value" style="font-size:20px" id="topProduct">-</div>
      </div>
      <div class="stat-card">
        <h3>Valeur totale du stock</h3>
        <div class="value" id="stockValue">0,00 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <h3>Alertes stock</h3>
        <div class="value" style="color:var(--warning)" id="stockAlerts">0</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="orders">üì¶ Commandes</button>
      <button class="tab-btn" data-tab="finances">üí∞ Finances</button>
      <button class="tab-btn" data-tab="payroll">üíº Paie</button>
      <button class="tab-btn" data-tab="stock">üìä Stock</button>
      <button class="tab-btn" data-tab="products">üõç Produits</button>
      <button class="tab-btn" data-tab="reviews">‚≠ê Avis</button>
      <button class="tab-btn" data-tab="settings">‚öôÔ∏è Param√®tres</button>
    </div>

    <!-- Tab: Commandes -->
    <div class="tab-content active" id="tab-orders">
      <div class="toolbar">
        <input type="text" id="searchOrders" placeholder="üîç Rechercher une commande...">
        <select id="filterStatus">
          <option value="all">Tous les statuts</option>
          <option value="pending">En attente</option>
          <option value="processing">En traitement</option>
          <option value="delivered">Livr√©</option>
          <option value="cancelled">Annul√©</option>
        </select>
        <button id="exportOrders">üì• Exporter CSV</button>
        <button id="refreshOrders">üîÑ Actualiser</button>
      </div>

      <div class="loading" id="ordersLoading">
        <div class="spinner"></div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Client</th>
              <th>Type</th>
              <th>Articles</th>
              <th>Total</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTable">
            <tr>
              <td colspan="8" class="empty-state">Aucune commande</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Finances -->
    <div class="tab-content" id="tab-finances">
      <!-- KPI Cards avanc√©s -->
      <div class="stats" style="margin-bottom:20px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
        <div class="stat-card">
          <h3>üí∞ Revenus totaux</h3>
          <div class="value" style="color:var(--success)" id="totalRevenue">0,00 ‚Ç¨</div>
        </div>
        <div class="stat-card">
          <h3>üí∏ D√©penses totales</h3>
          <div class="value" style="color:var(--danger)" id="totalExpenses">0,00 ‚Ç¨</div>
        </div>
        <div class="stat-card">
          <h3>üíé B√©n√©fice net</h3>
          <div class="value" id="netProfit">0,00 ‚Ç¨</div>
        </div>
        <div class="stat-card">
          <h3>üìä Marge b√©n√©ficiaire</h3>
          <div class="value" style="font-size:28px" id="profitMargin">0%</div>
          <div class="muted small">B√©n√©fice / Revenus</div>
        </div>
        <div class="stat-card">
          <h3>üìà Croissance CA</h3>
          <div class="value" style="font-size:28px" id="revenueGrowth">0%</div>
          <div class="muted small">vs mois pr√©c√©dent</div>
        </div>
        <div class="stat-card">
          <h3>üíµ Solde de caisse</h3>
          <div class="value" id="cashBalance">0,00 ‚Ç¨</div>
          <div class="muted small" id="cashStatus">√âtat de tr√©sorerie</div>
        </div>
        <div class="stat-card">
          <h3>üéØ Objectif mensuel</h3>
          <div class="value" style="font-size:24px" id="monthlyGoalProgress">0%</div>
          <div class="muted small"><span id="monthlyGoalAmount">0‚Ç¨</span> / <span id="monthlyGoalTarget">5000‚Ç¨</span></div>
        </div>
        <div class="stat-card">
          <h3>üìÜ Moyenne journali√®re</h3>
          <div class="value" style="font-size:24px" id="dailyAverage">0,00 ‚Ç¨</div>
          <div class="muted small">B√©n√©fice par jour</div>
        </div>
      </div>

      <!-- Gestion solde de caisse -->
      <div class="stock-form" style="margin-bottom:20px">
        <h3>üíµ Ajuster le solde de caisse</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end">
          <div>
            <label>Solde actuel</label>
            <input id="currentCashBalance" type="number" step="0.01" disabled>
          </div>
          <div>
            <label>Nouveau solde (‚Ç¨)</label>
            <input id="newCashBalance" type="number" step="0.01" placeholder="Ex: 1500.00">
          </div>
          <button id="updateCashBalance">üíæ Mettre √† jour</button>
        </div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">
          üí° Le solde de caisse repr√©sente l'argent liquide disponible. Il s'ajuste automatiquement avec les transactions en esp√®ces.
        </div>
      </div>

      <!-- Objectif mensuel -->
      <div class="stock-form" style="margin-bottom:20px">
        <h3>üéØ D√©finir l'objectif de chiffre d'affaires mensuel</h3>
        <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end">
          <div>
            <label>Objectif mensuel (‚Ç¨)</label>
            <input id="monthlyGoalInput" type="number" step="100" min="0" placeholder="Ex: 5000">
          </div>
          <button id="setMonthlyGoal">üéØ D√©finir</button>
        </div>
      </div>

      <!-- Formulaire ajout transaction am√©lior√© -->
      <div class="stock-form">
        <h3>‚ûï Nouvelle transaction</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 2fr 1fr 1fr;gap:10px;margin-bottom:10px">
          <div>
            <label>Type</label>
            <select id="transactionType">
              <option value="revenue">üí∞ Revenu</option>
              <option value="expense">üí∏ D√©pense</option>
            </select>
          </div>
          <div>
            <label>Cat√©gorie</label>
            <select id="transactionCategory">
              <option value="vente">Vente</option>
              <option value="achat_stock">Achat stock</option>
              <option value="livraison">Livraison</option>
              <option value="salaire">Salaire</option>
              <option value="loyer">Loyer</option>
              <option value="publicite">Publicit√©</option>
              <option value="commission">Commission</option>
              <option value="maintenance">Maintenance</option>
              <option value="assurance">Assurance</option>
              <option value="autre">Autre</option>
            </select>
          </div>
          <div>
            <label>Description</label>
            <input id="transactionDescription" placeholder="Ex: R√©approvisionnement AMNESIA 100G">
          </div>
          <div>
            <label>Montant (‚Ç¨)</label>
            <input id="transactionAmount" type="number" step="0.01" min="0" placeholder="0.00">
          </div>
          <div>
            <label>Date</label>
            <input id="transactionDate" type="date">
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end">
          <div>
            <label>Pay√© par</label>
            <select id="transactionPayment">
              <option value="especes">üíµ Esp√®ces</option>
              <option value="cb">üí≥ Carte bancaire</option>
              <option value="virement">üè¶ Virement</option>
              <option value="crypto">‚Çø Crypto</option>
              <option value="autre">Autre</option>
            </select>
          </div>
          <div>
            <label>Note (optionnel)</label>
            <input id="transactionNote" placeholder="Note interne...">
          </div>
          <button id="addTransaction">‚ûï Ajouter</button>
        </div>
      </div>

      <!-- Analyses et graphiques -->
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin:20px 0">
        <!-- Graphique principal -->
        <div class="chart-container">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0;cursor:pointer" onclick="toggleSection('financeChartContainer')">
              <span>üìà √âvolution financi√®re</span>
              <span id="financeChartContainerToggle" style="font-size:20px;margin-left:8px">‚ñº</span>
            </h3>
            <select id="chartPeriod" style="width:auto;margin:0;padding:8px">
              <option value="7">7 derniers jours</option>
              <option value="30" selected>30 derniers jours</option>
              <option value="90">90 derniers jours</option>
              <option value="365">Ann√©e compl√®te</option>
            </select>
          </div>
          <div id="financeChartContainer">
            <div id="financeChart" style="display:flex;gap:12px;align-items:flex-end;height:250px;padding:20px;background:var(--bg);border-radius:8px;overflow-x:auto">
              <div style="flex:1;text-align:center;color:var(--muted)">Chargement...</div>
            </div>
            <div style="display:flex;gap:20px;justify-content:center;margin-top:12px;font-size:13px">
              <div><span style="display:inline-block;width:12px;height:12px;background:var(--success);border-radius:2px;margin-right:6px"></span>Revenus</div>
              <div><span style="display:inline-block;width:12px;height:12px;background:var(--danger);border-radius:2px;margin-right:6px"></span>D√©penses</div>
              <div><span style="display:inline-block;width:12px;height:12px;background:var(--accent);border-radius:2px;margin-right:6px"></span>B√©n√©fice</div>
            </div>
          </div>
        </div>

        <!-- Top transactions -->
        <div class="chart-container">
          <h3 style="cursor:pointer" onclick="toggleSection('topExpenses')">
            <span>üèÜ Top 5 d√©penses</span>
            <span id="topExpensesToggle" style="font-size:20px;margin-left:8px">‚ñº</span>
          </h3>
          <div id="topExpenses" style="margin-top:12px"></div>
        </div>
      </div>

      <!-- Analyse par cat√©gorie et p√©riode -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <!-- D√©penses par cat√©gorie -->
        <div class="chart-container" style="cursor:pointer" onclick="toggleSection('categoryReport')">
          <h3 style="display:flex;justify-content:space-between;align-items:center">
            <span>üìä D√©penses par cat√©gorie</span>
            <span id="categoryReportToggle" style="font-size:20px;transition:transform 0.3s">‚ñº</span>
          </h3>
          <div id="categoryReport" style="margin-top:12px"></div>
        </div>

        <!-- Analyse temporelle -->
        <div class="chart-container" style="cursor:pointer" onclick="toggleSection('monthlyPerformance')">
          <h3 style="display:flex;justify-content:space-between;align-items:center">
            <span>üìÖ Performance mensuelle</span>
            <span id="monthlyPerformanceToggle" style="font-size:20px;transition:transform 0.3s">‚ñº</span>
          </h3>
          <div id="monthlyPerformance" style="margin-top:12px"></div>
        </div>
      </div>

      <!-- Pr√©visions et alertes -->
      <div class="chart-container" style="margin-bottom:20px">
        <h3 style="cursor:pointer;user-select:none" onclick="toggleSection('forecastSection')">
          <span>üîÆ Pr√©visions et analyse</span>
          <span id="forecastSectionToggle" style="font-size:20px;margin-left:8px;transition:transform 0.3s">‚ñº</span>
        </h3>
        <div id="forecastSection" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-top:12px">
          <div style="padding:16px;background:var(--bg);border-radius:8px;border-left:4px solid var(--accent)">
            <div style="font-weight:600;margin-bottom:8px">üìä Projection fin de mois</div>
            <div style="font-size:24px;color:var(--accent);margin-bottom:4px" id="projectionEndMonth">0,00 ‚Ç¨</div>
            <div class="muted small">Bas√© sur la moyenne des 7 derniers jours</div>
          </div>
          <div style="padding:16px;background:var(--bg);border-radius:8px;border-left:4px solid var(--success)">
            <div style="font-weight:600;margin-bottom:8px">üí∞ Meilleur jour</div>
            <div style="font-size:24px;color:var(--success);margin-bottom:4px" id="bestDay">0,00 ‚Ç¨</div>
            <div class="muted small" id="bestDayDate">-</div>
          </div>
          <div style="padding:16px;background:var(--bg);border-radius:8px;border-left:4px solid var(--warning)">
            <div style="font-weight:600;margin-bottom:8px">‚ö†Ô∏è Alertes</div>
            <div id="financeAlerts" style="font-size:13px"></div>
          </div>
        </div>
      </div>

      <!-- Filtres et recherche -->
      <div class="toolbar">
        <input type="text" id="searchTransaction" placeholder="üîç Rechercher une transaction...">
        <select id="filterTransactionType">
          <option value="all">Tous les types</option>
          <option value="revenue">üí∞ Revenus uniquement</option>
          <option value="expense">üí∏ D√©penses uniquement</option>
        </select>
        <select id="filterTransactionCategory">
          <option value="all">Toutes cat√©gories</option>
          <option value="vente">Vente</option>
          <option value="achat_stock">Achat stock</option>
          <option value="livraison">Livraison</option>
          <option value="salaire">Salaire</option>
          <option value="loyer">Loyer</option>
          <option value="publicite">Publicit√©</option>
          <option value="commission">Commission</option>
          <option value="maintenance">Maintenance</option>
          <option value="assurance">Assurance</option>
          <option value="autre">Autre</option>
        </select>
        <select id="filterTransactionPeriod">
          <option value="all">Toutes p√©riodes</option>
          <option value="today">Aujourd'hui</option>
          <option value="week">Cette semaine</option>
          <option value="month">Ce mois</option>
          <option value="lastmonth">Mois dernier</option>
          <option value="year">Cette ann√©e</option>
        </select>
        <select id="filterTransactionPayment">
          <option value="all">Tous paiements</option>
          <option value="especes">Esp√®ces</option>
          <option value="cb">Carte bancaire</option>
          <option value="virement">Virement</option>
          <option value="crypto">Crypto</option>
          <option value="autre">Autre</option>
        </select>
        <button id="exportFinances">üì• Export CSV</button>
        <button id="exportFinancesExcel">üìä Export Excel</button>
        <button id="refreshFinances">üîÑ Actualiser</button>
      </div>

      <!-- Historique transactions -->
      <h3 style="margin:20px 0 12px 0">üìã Historique des transactions</h3>
      <div class="loading" id="financesLoading">
        <div class="spinner"></div>
      </div>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Cat√©gorie</th>
              <th>Description</th>
              <th>Paiement</th>
              <th>Montant</th>
              <th>Note</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="transactionsTable">
            <tr>
              <td colspan="8" class="empty-state">Aucune transaction</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Paie -->
    <div class="tab-content" id="tab-payroll">
      <!-- Stats Paie -->
      <div class="stats" style="margin-bottom:20px">
        <div class="stat-card">
          <h3>üíº Masse salariale mensuelle</h3>
          <div class="value" style="color:var(--accent)" id="totalPayroll">0,00 ‚Ç¨</div>
          <div class="muted small">Total brut ce mois</div>
        </div>
        <div class="stat-card">
          <h3>üë• Employ√©s actifs</h3>
          <div class="value" id="activeEmployees">0</div>
          <div class="muted small">Salari√©s en poste</div>
        </div>
        <div class="stat-card">
          <h3>üìÖ Paies en attente</h3>
          <div class="value" style="color:var(--warning)" id="pendingPayments">0</div>
          <div class="muted small">√Ä payer ce mois</div>
        </div>
        <div class="stat-card">
          <h3>üí∏ Pay√© ce mois</h3>
          <div class="value" style="color:var(--success)" id="paidThisMonth">0,00 ‚Ç¨</div>
          <div class="muted small">D√©j√† vers√©</div>
        </div>
      </div>

      <!-- Ajouter un employ√© -->
      <div class="stock-form" style="margin-bottom:20px">
        <h3>‚ûï Ajouter un employ√©</h3>
        <div style="display:grid;grid-template-columns:2fr 2fr 1fr 1fr 2fr auto;gap:10px;margin-bottom:10px">
          <div>
            <label>Nom complet</label>
            <input id="employeeName" placeholder="Ex: Jean Dupont">
          </div>
          <div>
            <label>Poste</label>
            <input id="employeePosition" placeholder="Ex: Livreur">
          </div>
          <div>
            <label>Type</label>
            <select id="employeeType">
              <option value="mensuel">Mensuel</option>
              <option value="horaire">Horaire</option>
              <option value="journalier">Journalier</option>
            </select>
          </div>
          <div>
            <label>Salaire (‚Ç¨)</label>
            <input id="employeeSalary" type="number" step="0.01" placeholder="0.00">
          </div>
          <div>
            <label>Date d'embauche</label>
            <input id="employeeHireDate" type="date">
          </div>
          <button id="addEmployee">Ajouter</button>
        </div>
        <div style="font-size:12px;color:var(--muted)">
          üí° <strong>Mensuel:</strong> salaire fixe/mois ‚Ä¢ <strong>Horaire:</strong> tarif/heure ‚Ä¢ <strong>Journalier:</strong> tarif/jour
        </div>
      </div>

      <!-- Liste des employ√©s -->
      <h3 style="margin-bottom:12px">üë• Liste des employ√©s</h3>
      <div class="table-container" style="margin-bottom:30px">
        <table>
          <thead>
            <tr>
              <th>Nom</th>
              <th>Poste</th>
              <th>Type</th>
              <th>Salaire</th>
              <th>Date d'embauche</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="employeesTable">
            <tr>
              <td colspan="7" class="empty-state">Aucun employ√©</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- G√©n√©rer une paie -->
      <div class="stock-form" style="margin-bottom:20px">
        <h3>üí∏ G√©n√©rer une paie</h3>
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 2fr auto;gap:10px">
          <div>
            <label>Employ√©</label>
            <select id="payrollEmployee">
              <option value="">S√©lectionner...</option>
            </select>
          </div>
          <div>
            <label>Mois</label>
            <select id="payrollMonth">
              <option value="1">Janvier</option>
              <option value="2">F√©vrier</option>
              <option value="3">Mars</option>
              <option value="4">Avril</option>
              <option value="5">Mai</option>
              <option value="6">Juin</option>
              <option value="7">Juillet</option>
              <option value="8">Ao√ªt</option>
              <option value="9">Septembre</option>
              <option value="10">Octobre</option>
              <option value="11">Novembre</option>
              <option value="12">D√©cembre</option>
            </select>
          </div>
          <div>
            <label>Ann√©e</label>
            <input id="payrollYear" type="number" value="2025">
          </div>
          <div>
            <label>Heures/Jours</label>
            <input id="payrollHours" type="number" step="0.5" value="0" placeholder="0">
          </div>
          <div>
            <label>Primes (‚Ç¨)</label>
            <input id="payrollBonus" type="number" step="0.01" value="0" placeholder="0.00">
          </div>
          <div>
            <label>Note</label>
            <input id="payrollNote" placeholder="Optionnel">
          </div>
          <button id="generatePayroll">G√©n√©rer</button>
        </div>
      </div>

      <!-- Filtres -->
      <div class="toolbar">
        <select id="filterPayrollStatus">
          <option value="all">Tous les statuts</option>
          <option value="pending">En attente</option>
          <option value="paid">Pay√©</option>
        </select>
        <select id="filterPayrollMonth">
          <option value="all">Tous les mois</option>
          <option value="1">Janvier</option>
          <option value="2">F√©vrier</option>
          <option value="3">Mars</option>
          <option value="4">Avril</option>
          <option value="5">Mai</option>
          <option value="6">Juin</option>
          <option value="7">Juillet</option>
          <option value="8">Ao√ªt</option>
          <option value="9">Septembre</option>
          <option value="10">Octobre</option>
          <option value="11">Novembre</option>
          <option value="12">D√©cembre</option>
        </select>
        <select id="filterPayrollYear">
          <option value="all">Toutes les ann√©es</option>
          <option value="2025">2025</option>
          <option value="2024">2024</option>
        </select>
        <button id="exportPayroll">üì• Export CSV</button>
        <button id="refreshPayroll">üîÑ Actualiser</button>
      </div>

      <!-- Historique des paies -->
      <h3 style="margin:20px 0 12px 0">üìã Historique des paies</h3>
      <div class="loading" id="payrollLoading">
        <div class="spinner"></div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Employ√©</th>
              <th>P√©riode</th>
              <th>Salaire brut</th>
              <th>Primes</th>
              <th>Net √† payer</th>
              <th>Statut</th>
              <th>Date paiement</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="payrollTable">
            <tr>
              <td colspan="8" class="empty-state">Aucune paie enregistr√©e</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Rapport annuel -->
      <div class="chart-container" style="margin-top:30px">
        <h3>üìä √âvolution de la masse salariale</h3>
        <div id="payrollChart" style="display:flex;gap:12px;align-items:flex-end;height:200px;padding:20px;background:var(--bg);border-radius:8px;overflow-x:auto">
          <div style="flex:1;text-align:center;color:var(--muted)">Aucune donn√©e</div>
        </div>
      </div>
    </div>

    <!-- Tab: Stock -->
    <div class="tab-content" id="tab-stock">
      <!-- Formulaire mouvement -->
      <div class="stock-form">
        <h3>‚ûï Nouveau mouvement de stock</h3>
        <div class="stock-grid">
          <div>
            <label>Produit</label>
            <select id="stockProduct">
              <option value="">S√©lectionner...</option>
            </select>
          </div>
          <div>
            <label>Variant</label>
            <select id="stockVariant" disabled>
              <option value="">S√©lectionner...</option>
            </select>
          </div>
          <div>
            <label>Type</label>
            <select id="stockType">
              <option value="in">Entr√©e ‚ûï</option>
              <option value="out">Sortie ‚ûñ</option>
            </select>
          </div>
          <div>
            <label>Quantit√©</label>
            <input id="stockQty" type="number" min="1" value="1">
          </div>
          <div>
            <label>Motif</label>
            <input id="stockReason" placeholder="Optionnel">
          </div>
          <button id="addStockMovement">Ajouter</button>
        </div>
      </div>

      <!-- Stock actuel -->
      <h3 style="margin:20px 0 12px 0">üì¶ Stock actuel</h3>
      <div class="loading" id="stockLoading">
        <div class="spinner"></div>
      </div>
      <div class="table-container" style="margin-bottom:30px">
        <table>
          <thead>
            <tr>
              <th>Produit</th>
              <th>Variant</th>
              <th>Stock actuel</th>
              <th>Statut</th>
              <th>Valeur</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="stockTable"></tbody>
        </table>
      </div>

      <!-- Historique mouvements -->
      <h3 style="margin-bottom:12px">üìã Historique des mouvements</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Produit</th>
              <th>Variant</th>
              <th>Type</th>
              <th>Quantit√©</th>
              <th>Stock apr√®s</th>
              <th>Motif</th>
            </tr>
          </thead>
          <tbody id="movementsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Produits -->
    <div class="tab-content" id="tab-products">
      <div class="toolbar">
        <input type="text" id="searchProducts" placeholder="üîç Rechercher un produit...">
        <button id="addProduct">‚ûï Nouveau produit</button>
      </div>

      <div class="loading" id="productsLoading">
        <div class="spinner"></div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Produit</th>
              <th>Cat√©gorie</th>
              <th>Prix min</th>
              <th>Variants</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Avis -->
    <div class="tab-content" id="tab-reviews">
      <div class="toolbar">
        <select id="filterReviews">
          <option value="all">Tous les avis</option>
          <option value="approved">Approuv√©s</option>
          <option value="pending">En attente</option>
        </select>
        <button id="refreshReviews">üîÑ Actualiser</button>
      </div>

      <div class="loading" id="reviewsLoading">
        <div class="spinner"></div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Produit</th>
              <th>Client</th>
              <th>Note</th>
              <th>Commentaire</th>
              <th>Date</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="reviewsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Param√®tres -->
    <div class="tab-content" id="tab-settings">
      <div style="max-width:600px;margin:0 auto">
        <div style="background:var(--card);padding:30px;border-radius:12px;border:1px solid var(--border)">
          <h3 style="margin-bottom:20px">‚öôÔ∏è Param√®tres g√©n√©raux</h3>
          
          <div class="form-group">
            <label>Nom de la boutique</label>
            <input id="settingShopName" value="DROGUA CENTER">
          </div>
          
          <div class="form-group">
            <label>Frais de livraison ext√©rieure (‚Ç¨)</label>
            <input id="settingDeliveryFee" type="number" value="20">
          </div>
          
          <div class="form-group">
            <label>Remise fid√©lit√© (tous les X achats)</label>
            <input id="settingLoyalty" type="number" value="10">
          </div>
          
          <button id="saveSettings" style="margin-bottom:10px">üíæ Sauvegarder</button>
          <button id="logoutBtn" style="background:var(--danger)">üö™ Se d√©connecter</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Order Details -->
<div class="modal" id="modalOrder">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üì¶ D√©tails de la commande</h3>
      <button class="modal-close" onclick="closeModal('modalOrder')">‚úï</button>
    </div>
    <div class="modal-body" id="orderDetails"></div>
    <div class="modal-footer">
      <button onclick="closeModal('modalOrder')">Fermer</button>
    </div>
  </div>
</div>

<!-- Modal Edit Product -->
<div class="modal" id="modalEditProduct">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚úèÔ∏è √âditer le produit</h3>
      <button class="modal-close" onclick="closeModal('modalEditProduct')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nom du produit</label>
        <input id="editProductName" type="text">
      </div>
      <div class="form-group">
        <label>Cat√©gorie</label>
        <input id="editProductCategory" type="text">
      </div>
      <div class="form-group">
        <label>Fournisseur / Farm</label>
        <input id="editProductFarm" type="text">
      </div>
      <div class="form-group">
        <label>Statut</label>
        <select id="editProductActive">
          <option value="1">Actif</option>
          <option value="0">Inactif</option>
        </select>
      </div>
      <div class="form-group">
        <label>Variants (JSON)</label>
        <textarea id="editProductVariants" rows="6" placeholder='[{"label":"5G","price":30},{"label":"10G","price":60}]'></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('modalEditProduct')" style="background:var(--muted)">Annuler</button>
      <button id="saveProductBtn">üíæ Sauvegarder</button>
    </div>
  </div>
</div>

<!-- Modal Edit Order -->
<div class="modal" id="modalEditOrder">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚úèÔ∏è √âditer la commande</h3>
      <button class="modal-close" onclick="closeModal('modalEditOrder')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Client</label>
        <input id="editOrderCustomer" type="text">
      </div>
      <div class="form-group">
        <label>Type de livraison</label>
        <select id="editOrderType">
          <option value="Livraison sur Millau">Livraison sur Millau</option>
          <option value="Livraison ext√©rieure (+20‚Ç¨)">Livraison ext√©rieure (+20‚Ç¨)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Adresse</label>
        <textarea id="editOrderAddress" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label>Statut</label>
        <select id="editOrderStatus">
          <option value="pending">En attente</option>
          <option value="processing">En traitement</option>
          <option value="delivered">Livr√©</option>
          <option value="cancelled">Annul√©</option>
        </select>
      </div>
      <div class="form-group">
        <label>Total (‚Ç¨)</label>
        <input id="editOrderTotal" type="number" step="0.01">
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('modalEditOrder')" style="background:var(--muted)">Annuler</button>
      <button id="saveOrderBtn">üíæ Sauvegarder</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const API = 'https://biutique-production.up.railway.app/api';
const fmt = n => new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(n);
const ADMIN_PASS = 'gangstaforlife12';

let TOKEN = 'local-admin-token';
let USE_LOCAL_MODE = true;
let PRODUCTS_DATA = [
  {id:1, name:'AMNESIA', variants:[{label:'3,33G',price:20},{label:'5G',price:30},{label:'10G',price:60},{label:'50G',price:250},{label:'100G',price:450}]},
  {id:2, name:'NEEDLES KETA', variants:[{label:'1G',price:20},{label:'2G',price:40},{label:'3G',price:50},{label:'5G',price:80},{label:'10G',price:150}]},
  {id:3, name:'CHAMPAGNE', variants:[{label:'1G',price:20},{label:'2G',price:40},{label:'3G',price:50},{label:'5G',price:80},{label:'10G',price:150}]},
  {id:4, name:'EL JEFE', variants:[{label:'0,5G',price:30},{label:'1G',price:50},{label:'2G',price:100},{label:'5G',price:250},{label:'10G',price:430}]},
  {id:5, name:'SKITTLEZ CAKE 120u', variants:[{label:'2,5G',price:20},{label:'5G',price:40},{label:'10G',price:70},{label:'50G',price:290}]},
  {id:6, name:'PISTACCHIO 73u', variants:[{label:'3G',price:20},{label:'5G',price:50},{label:'10G',price:90},{label:'50G',price:250}]},
  {id:7, name:'DEMBELE', variants:[{label:'3,5G',price:20},{label:'5G',price:30},{label:'10G',price:50},{label:'50G',price:190},{label:'100G',price:370}]},
  {id:8, name:'LEMON X GELATO', variants:[{label:'1,66G',price:20},{label:'3,5G',price:40},{label:'5G',price:60},{label:'10G',price:110}]},
  {id:9, name:'GEORGIA PIE', variants:[{label:'1,66G',price:20},{label:'3,5G',price:40},{label:'5G',price:60},{label:'10G',price:110}]},
  {id:10, name:'DOMINO 280mg', variants:[{label:'3 unit√©s',price:20},{label:'10 unit√©s',price:60},{label:'50 unit√©s',price:150}]},
  {id:11, name:'FRESH FROZEN', variants:[{label:'1,1G',price:20},{label:'2,3G',price:40},{label:'3,5G',price:50},{label:'5G',price:80},{label:'10G',price:160}]}
];

// === UTILITIES ===
function showToast(msg, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = `toast ${type} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function showLoading(id) {
  document.getElementById(id)?.classList.add('active');
}

function hideLoading(id) {
  document.getElementById(id)?.classList.remove('active');
}

function closeModal(id) {
  document.getElementById(id)?.classList.remove('active');
}

function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  const toggle = document.getElementById(sectionId + 'Toggle');
  
  if (section.style.display === 'none') {
    section.style.display = 'block';
    if (toggle) toggle.textContent = '‚ñº';
  } else {
    section.style.display = 'none';
    if (toggle) toggle.textContent = '‚ñ∂';
  }
}

async function apiCall(endpoint, options = {}) {
  if (USE_LOCAL_MODE) {
    return handleLocalStorage(endpoint, options);
  }
  
  const headers = { 'Content-Type': 'application/json' };
  if (TOKEN) headers['x-admin-token'] = TOKEN;
  
  const response = await fetch(API + endpoint, {
    ...options,
    headers: { ...headers, ...options.headers }
  });
  
  if (!response.ok) {
    if (response.status === 401) {
      showToast('Session expir√©e', 'error');
      logout();
      throw new Error('Unauthorized');
    }
    throw new Error('API Error');
  }
  
  return response.json();
}

function handleLocalStorage(endpoint, options) {
  const method = options.method || 'GET';
  
  if (endpoint === '/admin/stats') return getLocalStats();
  
  if (endpoint.startsWith('/admin/orders')) {
    if (method === 'GET') return getLocalOrders();
    if (method === 'PUT') return updateLocalOrder(endpoint, options);
    if (method === 'DELETE') return deleteLocalOrder(endpoint);
  }
  
  if (endpoint === '/admin/stock') return getLocalStock();
  if (endpoint === '/admin/stock/movement') return addLocalStockMovement(options);
  if (endpoint === '/admin/stock/movements') return getLocalMovements();
  
  if (endpoint === '/admin/reviews') {
    if (method === 'GET') return getLocalReviews();
    if (method === 'PUT') return updateLocalReview(endpoint, options);
    if (method === 'DELETE') return deleteLocalReview(endpoint);
  }
  
  if (endpoint === '/admin/settings') {
    if (method === 'GET') return getLocalSettings();
    if (method === 'PUT') return saveLocalSettings(options);
  }
  
  return { ok: true, data: [] };
}

function getLocalOrders() {
  const orders = JSON.parse(localStorage.getItem('admin_orders') || '[]');
  orders.forEach(o => {
    if (typeof o.items === 'string') {
      o.items = JSON.parse(o.items || '[]');
    } else if (!o.items) {
      o.items = [];
    }
  });
  return { ok: true, orders };
}

function updateLocalOrder(endpoint, options) {
  const id = parseInt(endpoint.split('/').pop());
  const orders = JSON.parse(localStorage.getItem('admin_orders') || '[]');
  const orderIndex = orders.findIndex(o => o.id === id);
  
  if (orderIndex !== -1 && options.body) {
    const data = JSON.parse(options.body);
    orders[orderIndex] = { ...orders[orderIndex], ...data };
    
    if (orders[orderIndex].items && typeof orders[orderIndex].items === 'string') {
      orders[orderIndex].items = JSON.parse(orders[orderIndex].items);
    }
    
    localStorage.setItem('admin_orders', JSON.stringify(orders));
  }
  return { ok: true };
}

function deleteLocalOrder(endpoint) {
  const id = parseInt(endpoint.split('/').pop());
  let orders = JSON.parse(localStorage.getItem('admin_orders') || '[]');
  orders = orders.filter(o => o.id !== id);
  localStorage.setItem('admin_orders', JSON.stringify(orders));
  return { ok: true };
}

function getLocalStats() {
  try {
    const orders = JSON.parse(localStorage.getItem('admin_orders') || '[]');
    const totalCA = orders.reduce((sum, o) => sum + (o.total || 0), 0);
    const totalOrders = orders.length;
    const avgOrder = totalOrders > 0 ? totalCA / totalOrders : 0;
    
    const itemCounts = {};
    orders.forEach(o => {
      try {
        let items = o.items;
        if (typeof items === 'string') items = JSON.parse(items);
        if (!Array.isArray(items)) items = [];
        
        items.forEach(it => {
          if (it && it.name && it.qty) {
            itemCounts[it.name] = (itemCounts[it.name] || 0) + it.qty;
          }
        });
      } catch (e) {
        console.warn('Error parsing items for order:', o.id, e);
      }
    });
    const topProduct = Object.entries(itemCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || '-';
    
    const stock = JSON.parse(localStorage.getItem('stock_data') || '{}');
    let stockValue = 0, stockOut = 0, stockLow = 0;
    
    Object.entries(stock).forEach(([key, qty]) => {
      const [productId, variant] = key.split('_');
      const product = PRODUCTS_DATA.find(p => p.id === parseInt(productId));
      if (product) {
        const v = product.variants.find(v => v.label === variant);
        if (v) {
          stockValue += qty * v.price;
          if (qty === 0) stockOut++;
          else if (qty < 10) stockLow++;
        }
      }
    });
    
    return {
      ok: true,
      stats: { totalCA, totalOrders, avgOrder, topProduct, stockValue, stockOut, stockLow }
    };
  } catch (e) {
    console.error('Fatal error in getLocalStats:', e);
    return {
      ok: true,
      stats: { totalCA: 0, totalOrders: 0, avgOrder: 0, topProduct: '-', stockValue: 0, stockOut: 0, stockLow: 0 }
    };
  }
}

function getLocalStock() {
  const stockData = JSON.parse(localStorage.getItem('stock_data') || '{}');
  const stock = [];
  
  Object.entries(stockData).forEach(([key, qty]) => {
    const [productId, variant] = key.split('_');
    stock.push({
      product_id: parseInt(productId),
      variant,
      qty
    });
  });
  
  return { ok: true, stock };
}

function addLocalStockMovement(options) {
  const data = JSON.parse(options.body);
  const { product_id, variant, type, quantity, reason } = data;
  
  const stock = JSON.parse(localStorage.getItem('stock_data') || '{}');
  const key = `${product_id}_${variant}`;
  const currentQty = stock[key] || 0;
  
  let newQty = currentQty;
  if (type === 'in') newQty = currentQty + quantity;
  else newQty = Math.max(0, currentQty - quantity);
  
  stock[key] = newQty;
  localStorage.setItem('stock_data', JSON.stringify(stock));
  
  const movements = JSON.parse(localStorage.getItem('stock_movements') || '[]');
  movements.unshift({
    product_id,
    variant,
    type,
    quantity,
    stock_after: newQty,
    reason: reason || '',
    created_at: new Date().toISOString()
  });
  localStorage.setItem('stock_movements', JSON.stringify(movements));
  
  return { ok: true, newQty };
}

function getLocalMovements() {
  const movements = JSON.parse(localStorage.getItem('stock_movements') || '[]');
  return { ok: true, movements };
}

function getLocalReviews() {
  const reviewsObj = JSON.parse(localStorage.getItem('product_reviews') || '{}');
  const reviews = [];
  
  Object.entries(reviewsObj).forEach(
